
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Feature Engineering: Core Technical Indicators &#8212; My Jupyter Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b76e3c8a" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '01_parse_midpoint_xauusd (final)';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">My Jupyter Book</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    <no title>
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="XAUUSD%20Research.html">XAUUSD Research</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/01_parse_midpoint_xauusd (final).ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Feature Engineering: Core Technical Indicators</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Feature Engineering: Core Technical Indicators</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#indicators-included">Indicators Included</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mathematical-concepts-used">Mathematical Concepts Used</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-pipeline-indicator-enrichment-to-pca-compression">Feature Pipeline: Indicator Enrichment to PCA Compression</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#steps-performed">Steps Performed</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Mathematical Concepts Used</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#pca-scree-plot-explained-variance-analysis">PCA Scree Plot: Explained Variance Analysis</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpretation">Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Mathematical Concepts Used</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#visual-preview-of-technical-indicators">Visual Preview of Technical Indicators</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#indicators-plotted">Indicators Plotted</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpretation-and-issue-observed">Interpretation and Issue Observed</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-this-means">What This Means</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#pca-on-de-correlated-indicators">🔍 PCA on De-correlated Indicators</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#scree-plot-interpretation">Scree Plot Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mathematical-justification">Mathematical Justification</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#pca-loadings-feature-contributions-to-pc1-and-pc2">📊 PCA Loadings: Feature Contributions to PC1 and PC2</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#observations-from-the-plot">Observations from the Plot</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Interpretation</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#pca-projection-feature-space-in-pc1-vs-pc2">🎯 PCA Projection: Feature Space in PC1 vs PC2</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-this-plot-shows">What This Plot Shows</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-this-matters">Why This Matters</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#log-volume-transformation-decorrelated-indicator-engineering">🧮 Log-Volume Transformation &amp; Decorrelated Indicator Engineering</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">📌 Steps Performed</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#pca-on-cleaned-expanded-indicators">PCA on Cleaned + Expanded Indicators</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#processing-steps">Processing Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Scree Plot Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Mathematical Concepts Used</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#pca-on-standardized-features-with-log-volume">🧮 PCA on Standardized Features with Log-Volume</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#process">🔧 Process</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">📊 Scree Plot Interpretation</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#final-pca-scree-plot-fully-expanded-cleaned-features">Final PCA Scree Plot – Fully Expanded &amp; Cleaned Features</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pca-insights">PCA Insights</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#takeaway">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#pca-projection-pc1-vs-pc2-scatter">PCA Projection: PC1 vs PC2 Scatter</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visual-interpretation">Visual Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mathematical-implication">Mathematical Implication</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#logistic-regression-on-pca-components-rocauc-evaluation">Logistic Regression on PCA Components: ROC‑AUC Evaluation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-setup">Model Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results-and-interpretation">Results and Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#prediction-confidence-check-histogram-of-logistic-regression-probabilities">Prediction Confidence Check: Histogram of Logistic Regression Probabilities</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#purpose">Purpose</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implications">Implications</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#logistic-regression-on-pca-features-2-bar-roc-auc-evaluation">Logistic Regression on PCA Features: 2-Bar ROC-AUC Evaluation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">Model Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">Results and Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">Implications</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#predicted-probability-histogram-2-bar-horizon">Predicted Probability Histogram (2-Bar Horizon)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implication">Implication</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#backtest-results-r-multiple-distributions-by-threshold">Backtest Results: R-Multiple Distributions by Threshold</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id18">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#random-forest-classifier-roc-auc-and-pca-feature-importance">Random Forest Classifier: ROC-AUC and PCA Feature Importance</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id19">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#backtest-results-random-forest-signal-at-0-52">Backtest Results: Random Forest Signal at α = 0.52</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id20">Results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id21">Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id22">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#logistic-regression-roc-curve-2bar-horizon">Logistic Regression ROC Curve (2‑Bar Horizon)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-function">The Function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-i-did-this">Why I Did This</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#narrative">Narrative</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id23">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#random-forest-backtest-r-multiple-histogram-0-52">📊 Random Forest Backtest – R-Multiple Histogram (α = 0.52)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id24">The Function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id25">Why I Did This</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id26">Narrative</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id27">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#roc-auc-pattern-frequency-xgboost-with-candlestick-signals">🔍 ROC-AUC &amp; Pattern Frequency – XGBoost with Candlestick Signals</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id28">The Function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id29">Why I Did This</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id30">Narrative</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id31">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#xgboost-with-10-candlestick-patterns-roc-auc-r-multiple-histogram">📊 XGBoost with 10 Candlestick Patterns – ROC-AUC &amp; R-Multiple Histogram</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id32">The Function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id33">Why I Did This</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id34">Narrative</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id35">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#transactioncost-simulation">7. Transaction‑Cost Simulation</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#transaction-cost-simulation-net-r-multiples">💸 Transaction Cost Simulation – Net R-Multiples</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id36">The Function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id37">Why I Did This</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id38">Narrative</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id39">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#short-side-strategy-analysis-profit-target-optimization">Short-Side Strategy Analysis: Profit Target Optimization</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#method">Method</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#observations">Observations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id40">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#regime-aware-model-with-ta-lib-patterns">Regime-Aware Model with TA-Lib Patterns</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id41">The Function</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#regime-aware-long-backtest-0-60">Regime-Aware Long Backtest (α = 0.60)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id42">The Function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-we-did-this-research-and-this-path">Why We Did This Research and This Path</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id43">Narrative</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id44">Takeaway</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>ta
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Defaulting to user installation because normal site-packages is not writeable
Requirement already satisfied: ta in c:\users\k t\appdata\roaming\python\python312\site-packages (0.11.0)
Requirement already satisfied: numpy in c:\anaconda\lib\site-packages (from ta) (1.26.4)
Requirement already satisfied: pandas in c:\anaconda\lib\site-packages (from ta) (2.2.2)
Requirement already satisfied: python-dateutil&gt;=2.8.2 in c:\anaconda\lib\site-packages (from pandas-&gt;ta) (2.9.0.post0)
Requirement already satisfied: pytz&gt;=2020.1 in c:\anaconda\lib\site-packages (from pandas-&gt;ta) (2024.1)
Requirement already satisfied: tzdata&gt;=2022.7 in c:\anaconda\lib\site-packages (from pandas-&gt;ta) (2023.3)
Requirement already satisfied: six&gt;=1.5 in c:\anaconda\lib\site-packages (from python-dateutil&gt;=2.8.2-&gt;pandas-&gt;ta) (1.16.0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># Set your data directory (you already uploaded to &quot;GOLD&quot; folder)</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;GOLD&quot;</span><span class="p">)</span>

<span class="c1"># Lists of filenames</span>
<span class="n">ask_files</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;GOLD_ASK</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">.csv&quot;</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">2026</span><span class="p">)]</span>
<span class="n">bid_files</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;GOLD_BID</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">.csv&quot;</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">2026</span><span class="p">)]</span>

<span class="c1"># 🔁 Updated read function with comma separator</span>
<span class="k">def</span> <span class="nf">read_gold_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>  <span class="c1"># auto-detect comma separator</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">✅ Preview from file: </span><span class="si">{</span><span class="n">file_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>  <span class="c1"># show a fe</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># ─── CONFIG ───────────────────────────────────────────────────────────────────</span>
<span class="c1"># Relative path to the folder containing your 12 CSVs:</span>
<span class="c1"># (Assumes this notebook lives in a subfolder of your repo; adjust &quot;../GOLD&quot; if needed)</span>
<span class="n">data_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="s2">&quot;GOLD&quot;</span><span class="p">)</span>
<span class="c1"># ────────────────────────────────────────────────────────────────────────────────</span>

<span class="c1"># Prepare a list to collect each year&#39;s cleaned data</span>
<span class="n">all_years_data</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Loop through each year 2020–2025</span>
<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">2026</span><span class="p">):</span>
    <span class="n">ask_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;GOLD_ASK</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>
    <span class="n">bid_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;GOLD_BID</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>

    <span class="c1"># Read ASK and BID (comma-separated)</span>
    <span class="n">df_ask</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ask_file</span><span class="p">)</span>
    <span class="n">df_bid</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">bid_file</span><span class="p">)</span>

    <span class="c1"># Rename columns so we can merge</span>
    <span class="n">df_ask</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Gmt time&quot;</span><span class="p">,</span> <span class="s2">&quot;Open_ask&quot;</span><span class="p">,</span> <span class="s2">&quot;High_ask&quot;</span><span class="p">,</span> <span class="s2">&quot;Low_ask&quot;</span><span class="p">,</span> <span class="s2">&quot;Close_ask&quot;</span><span class="p">,</span> <span class="s2">&quot;Volume_ask&quot;</span><span class="p">]</span>
    <span class="n">df_bid</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Gmt time&quot;</span><span class="p">,</span> <span class="s2">&quot;Open_bid&quot;</span><span class="p">,</span> <span class="s2">&quot;High_bid&quot;</span><span class="p">,</span> <span class="s2">&quot;Low_bid&quot;</span><span class="p">,</span> <span class="s2">&quot;Close_bid&quot;</span><span class="p">,</span> <span class="s2">&quot;Volume_bid&quot;</span><span class="p">]</span>

    <span class="c1"># Merge on the GMT timestamp</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_ask</span><span class="p">,</span> <span class="n">df_bid</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Gmt time&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>

    <span class="c1"># Parse &#39;Gmt time&#39; into datetime</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Gmt time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Gmt time&quot;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">.%m.%Y %H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Compute midpoint OHLC and average volume</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_ask&quot;</span><span class="p">]</span>  <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Open_bid&quot;</span><span class="p">])</span>  <span class="o">/</span> <span class="mi">2</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;High&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;High_ask&quot;</span><span class="p">]</span>  <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;High_bid&quot;</span><span class="p">])</span>  <span class="o">/</span> <span class="mi">2</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Low&quot;</span><span class="p">]</span>    <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Low_ask&quot;</span><span class="p">]</span>   <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Low_bid&quot;</span><span class="p">])</span>   <span class="o">/</span> <span class="mi">2</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close_ask&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close_bid&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Volume_ask&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Volume_bid&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># Convert to WIB local time (UTC+7)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Gmt time&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

    <span class="c1"># Select final columns</span>
    <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Local time&quot;</span><span class="p">,</span> <span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Volume&quot;</span><span class="p">]]</span>

    <span class="c1"># Append to list</span>
    <span class="n">all_years_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_clean</span><span class="p">)</span>

<span class="c1"># Concatenate all years</span>
<span class="n">gold_midpoint</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_years_data</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Sort by time and reset index</span>
<span class="n">gold_midpoint</span> <span class="o">=</span> <span class="n">gold_midpoint</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;Local time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Preview the merged midpoint data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Parsed and merged midpoint data – preview:&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">gold_midpoint</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

<span class="c1"># (Optional) Save to CSV for later steps</span>
<span class="n">gold_midpoint</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;gold_midpoint_5min_wib.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Saved merged midpoint file as &#39;gold_midpoint_5min_wib.csv&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ Parsed and merged midpoint data – preview:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Local time</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Volume</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2020-01-01 07:00:00</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2020-01-01 07:05:00</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2020-01-01 07:10:00</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2020-01-01 07:15:00</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2020-01-01 07:20:00</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ Saved merged midpoint file as &#39;gold_midpoint_5min_wib.csv&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ta</span>  <span class="c1"># Technical Analysis library</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Use the already-created DataFrame: `gold_midpoint`</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">gold_midpoint</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># 1. EMAs</span>
<span class="k">for</span> <span class="n">span</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">200</span><span class="p">]:</span>
    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;EMA_</span><span class="si">{</span><span class="n">span</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ewm</span><span class="p">(</span><span class="n">span</span><span class="o">=</span><span class="n">span</span><span class="p">,</span> <span class="n">adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># 2. RSI(14)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;RSI_14&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">momentum</span><span class="o">.</span><span class="n">RSIIndicator</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">rsi</span><span class="p">()</span>

<span class="c1"># 3. MACD (12,26) + Histogram</span>
<span class="n">macd</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">trend</span><span class="o">.</span><span class="n">MACD</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">window_slow</span><span class="o">=</span><span class="mi">26</span><span class="p">,</span> <span class="n">window_fast</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">window_sign</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;MACD&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">macd</span><span class="o">.</span><span class="n">macd</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;MACD_hist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">macd</span><span class="o">.</span><span class="n">macd_diff</span><span class="p">()</span>

<span class="c1"># 4. ATR(14)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">volatility</span><span class="o">.</span><span class="n">AverageTrueRange</span><span class="p">(</span>
    <span class="n">high</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">],</span> <span class="n">low</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">],</span> <span class="n">close</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">14</span>
<span class="p">)</span><span class="o">.</span><span class="n">average_true_range</span><span class="p">()</span>

<span class="c1"># 5. Rolling StdDev (20)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;STDDEV_20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

<span class="c1"># 6. ADX (14), +DI, –DI</span>
<span class="n">adx</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">trend</span><span class="o">.</span><span class="n">ADXIndicator</span><span class="p">(</span>
    <span class="n">high</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">],</span> <span class="n">low</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">],</span> <span class="n">close</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">14</span>
<span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;ADX_14&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adx</span><span class="o">.</span><span class="n">adx</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;+DI_14&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adx</span><span class="o">.</span><span class="n">adx_pos</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;-DI_14&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adx</span><span class="o">.</span><span class="n">adx_neg</span><span class="p">()</span>

<span class="c1"># Preview</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Core indicators added. Preview:&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;EMA|RSI|MACD|ATR|STDDEV|ADX&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ Core indicators added. Preview:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>EMA_9</th>
      <th>EMA_21</th>
      <th>EMA_50</th>
      <th>EMA_200</th>
      <th>RSI_14</th>
      <th>MACD</th>
      <th>MACD_hist</th>
      <th>ATR_14</th>
      <th>STDDEV_20</th>
      <th>ADX_14</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>1517.465</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="feature-engineering-core-technical-indicators">
<h1>Feature Engineering: Core Technical Indicators<a class="headerlink" href="#feature-engineering-core-technical-indicators" title="Link to this heading">#</a></h1>
<p>In this section, we enrich the raw gold 5-minute midpoint price data with a curated set of technical indicators commonly used in momentum, trend-following, and volatility-based strategies. These indicators are later used as features for modeling and dimensionality reduction.</p>
<section id="indicators-included">
<h2>Indicators Included<a class="headerlink" href="#indicators-included" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>EMA (9, 21, 50, 200)</strong>: Exponential moving averages that capture trend behavior at different time scales.</p></li>
<li><p><strong>RSI (14)</strong>: A momentum oscillator comparing recent gains to losses. Values above 70 indicate overbought; below 30 indicate oversold.</p></li>
<li><p><strong>MACD (12, 26, 9)</strong>: Measures momentum and trend strength via the difference between short and long EMAs.</p></li>
<li><p><strong>MACD Histogram</strong>: Visualizes the rate of MACD convergence/divergence.</p></li>
<li><p><strong>ATR (14)</strong>: Average True Range estimates recent volatility, useful for risk and stop-loss calculations.</p></li>
<li><p><strong>Rolling StdDev (20)</strong>: A statistical measure of price dispersion over 20 bars.</p></li>
<li><p><strong>ADX (+DI, –DI)</strong>: The Average Directional Index gauges trend strength and directionality.</p></li>
</ul>
<p>These indicators are researched based on popular</p>
<p>These features are computed using the <code class="docutils literal notranslate"><span class="pre">ta</span></code> (technical analysis) Python library and stored in the <code class="docutils literal notranslate"><span class="pre">df</span></code> DataFrame for later use.</p>
</section>
<section id="mathematical-concepts-used">
<h2>Mathematical Concepts Used<a class="headerlink" href="#mathematical-concepts-used" title="Link to this heading">#</a></h2>
<p>This cell leverages:</p>
<ul class="simple">
<li><p><strong>Exponential smoothing</strong> (for EMAs and MACD),</p></li>
<li><p><strong>Vector algebra</strong> (price deltas in RSI),</p></li>
<li><p><strong>Rolling window statistics</strong> (StdDev, ATR),</p></li>
<li><p><strong>Directional volatility logic</strong> (ADX family indicators).</p></li>
</ul>
<p>All indicators are calculated in a vectorized fashion and serve as model-ready inputs for both supervised ML and unsupervised techniques like PCA.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">ta.trend</span> <span class="kn">import</span> <span class="n">EMAIndicator</span><span class="p">,</span> <span class="n">MACD</span><span class="p">,</span> <span class="n">ADXIndicator</span>
<span class="kn">from</span> <span class="nn">ta.momentum</span> <span class="kn">import</span> <span class="n">RSIIndicator</span><span class="p">,</span> <span class="n">StochasticOscillator</span>
<span class="kn">from</span> <span class="nn">ta.volatility</span> <span class="kn">import</span> <span class="n">AverageTrueRange</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="c1"># Load clean midpoint file</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_midpoint_5min_wib.csv&quot;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">])</span>

<span class="c1"># Set up the indicators</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;EMA_9&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMAIndicator</span><span class="p">(</span><span class="n">close</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span><span class="n">ema_indicator</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;EMA_21&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMAIndicator</span><span class="p">(</span><span class="n">close</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span><span class="o">.</span><span class="n">ema_indicator</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;EMA_50&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMAIndicator</span><span class="p">(</span><span class="n">close</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">ema_indicator</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;EMA_200&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">EMAIndicator</span><span class="p">(</span><span class="n">close</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span><span class="o">.</span><span class="n">ema_indicator</span><span class="p">()</span>

<span class="n">macd</span> <span class="o">=</span> <span class="n">MACD</span><span class="p">(</span><span class="n">close</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;MACD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">macd</span><span class="o">.</span><span class="n">macd</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;MACD_hist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">macd</span><span class="o">.</span><span class="n">macd_diff</span><span class="p">()</span>

<span class="n">df</span><span class="p">[</span><span class="s2">&quot;RSI_14&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RSIIndicator</span><span class="p">(</span><span class="n">close</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">rsi</span><span class="p">()</span>

<span class="n">atr</span> <span class="o">=</span> <span class="n">AverageTrueRange</span><span class="p">(</span><span class="n">high</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;High&quot;</span><span class="p">],</span> <span class="n">low</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Low&quot;</span><span class="p">],</span> <span class="n">close</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;ATR_14&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atr</span><span class="o">.</span><span class="n">average_true_range</span><span class="p">()</span>

<span class="n">df</span><span class="p">[</span><span class="s2">&quot;STDDEV_20&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

<span class="n">adx</span> <span class="o">=</span> <span class="n">ADXIndicator</span><span class="p">(</span><span class="n">high</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;High&quot;</span><span class="p">],</span> <span class="n">low</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Low&quot;</span><span class="p">],</span> <span class="n">close</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;ADX_14&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adx</span><span class="o">.</span><span class="n">adx</span><span class="p">()</span>

<span class="c1"># Drop early NaNs</span>
<span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># ✅ Save this as the master dataset with indicators</span>
<span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;gold_with_indicators.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Indicators added and saved to &#39;gold_with_indicators.csv&#39;&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ Indicators added and saved to &#39;gold_with_indicators.csv&#39;
             Local time      Open      High       Low     Close  Volume  \
199 2020-01-01 23:35:00  1517.465  1517.465  1517.465  1517.465     0.0   
200 2020-01-01 23:40:00  1517.465  1517.465  1517.465  1517.465     0.0   
201 2020-01-01 23:45:00  1517.465  1517.465  1517.465  1517.465     0.0   
202 2020-01-01 23:50:00  1517.465  1517.465  1517.465  1517.465     0.0   
203 2020-01-01 23:55:00  1517.465  1517.465  1517.465  1517.465     0.0   

        EMA_9    EMA_21    EMA_50   EMA_200  MACD  MACD_hist  RSI_14  ATR_14  \
199  1517.465  1517.465  1517.465  1517.465   0.0        0.0   100.0     0.0   
200  1517.465  1517.465  1517.465  1517.465   0.0        0.0   100.0     0.0   
201  1517.465  1517.465  1517.465  1517.465   0.0        0.0   100.0     0.0   
202  1517.465  1517.465  1517.465  1517.465   0.0        0.0   100.0     0.0   
203  1517.465  1517.465  1517.465  1517.465   0.0        0.0   100.0     0.0   

     STDDEV_20  ADX_14  
199        0.0     0.0  
200        0.0     0.0  
201        0.0     0.0  
202        0.0     0.0  
203        0.0     0.0  
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Load the enriched data</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_with_indicators.csv&quot;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">])</span>

<span class="c1"># 👁️ Quick stats for sanity check</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>

<span class="c1"># 🔍 Check NaNs and unique values per indicator</span>
<span class="n">indicator_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;EMA&quot;</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;MACD&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;RSI&quot;</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ATR&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;STDDEV&quot;</span><span class="p">)</span> <span class="ow">or</span>
                  <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ADX&quot;</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">indicator_cols</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">🔎 </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NaNs: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">, Unique values: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                          Local time           Open           High  \
count                         360550  360550.000000  360550.000000   
mean   2022-08-22 22:09:52.802662400    2000.025115    2000.738905   
min              2020-01-01 23:35:00    1453.938500    1456.753500   
25%              2021-04-19 15:01:15    1785.760375    1786.304250   
50%              2022-08-19 11:42:30    1889.444250    1890.195000   
75%              2023-12-21 13:58:45    2027.616125    2028.193375   
max              2025-05-02 06:55:00    3497.455000    3500.215000   
std                              NaN     355.994497     356.132721   

                 Low          Close        Volume          EMA_9  \
count  360550.000000  360550.000000  3.605500e+05  360550.000000   
mean     1999.300556    2000.029423  1.541201e+05    2000.010341   
min      1451.320000    1453.953500  0.000000e+00    1459.281396   
25%      1785.155375    1785.761625  5.105000e+04    1785.746566   
50%      1888.745750    1889.435000  1.096050e+05    1889.531892   
75%      2027.056125    2027.614125  2.074352e+05    2027.608781   
max      3494.235000    3497.485000  4.526065e+06    3491.689470   
std       355.855919     356.000907  1.534309e+05     355.976090   

              EMA_21         EMA_50        EMA_200           MACD  \
count  360550.000000  360550.000000  360550.000000  360550.000000   
mean     1999.981764    1999.912979    1999.553833       0.033304   
min      1464.324195    1470.700199    1475.614515     -18.108263   
25%      1785.707791    1785.499510    1785.107133      -0.489865   
50%      1889.698502    1889.535644    1889.537518       0.036379   
75%      2027.677841    2027.877018    2027.108906       0.594899   
max      3487.392971    3479.131126    3452.025695      15.417605   
std       355.939785     355.853090     355.389477       1.364301   

           MACD_hist        RSI_14         ATR_14      STDDEV_20  \
count  360550.000000  3.605500e+05  360550.000000  360550.000000   
mean        0.000034  5.062425e+01       1.453173       1.648293   
min        -7.333570  9.952686e-09       0.000000       0.000000   
25%        -0.165672  4.286652e+01       0.861777       0.757812   
50%        -0.000295  5.064211e+01       1.227784       1.215417   
75%         0.167741  5.833587e+01       1.792232       1.990020   
max         8.049138  1.000000e+02      13.104650      29.900251   
std         0.408222  1.163636e+01       0.927204       1.551577   

              ADX_14  
count  360550.000000  
mean       25.102646  
min         0.000000  
25%        17.277231  
50%        23.023978  
75%        30.871196  
max        85.204058  
std        10.552696  

🔎 EMA_9:
NaNs: 0, Unique values: 359129

🔎 EMA_21:
NaNs: 0, Unique values: 360362

🔎 EMA_50:
NaNs: 0, Unique values: 360474

🔎 EMA_200:
NaNs: 0, Unique values: 360474

🔎 MACD:
NaNs: 0, Unique values: 360474

🔎 MACD_hist:
NaNs: 0, Unique values: 360474

🔎 RSI_14:
NaNs: 0, Unique values: 348361

🔎 ATR_14:
NaNs: 0, Unique values: 360474

🔎 STDDEV_20:
NaNs: 0, Unique values: 357345

🔎 ADX_14:
NaNs: 0, Unique values: 360474
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="c1"># Exclude time and price columns, only keep indicators</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">indicator_cols</span><span class="p">]</span>

<span class="c1"># Standardize</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">features_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

<span class="c1"># Convert back to DataFrame for easy use</span>
<span class="n">df_scaled</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">features_scaled</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_z&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">indicator_cols</span><span class="p">])</span>
<span class="n">df_scaled</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">]</span>

<span class="c1"># ✅ Save it</span>
<span class="n">df_scaled</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;gold_indicators_standardized.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Standardized indicator data saved to &#39;gold_indicators_standardized.csv&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ Standardized indicator data saved to &#39;gold_indicators_standardized.csv&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Load the enriched gold data with indicators</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_with_indicators.csv&quot;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">])</span>

<span class="c1"># Identify constant columns</span>
<span class="n">constant_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🧾 Constant columns detected and removed:&quot;</span><span class="p">,</span> <span class="n">constant_cols</span><span class="p">)</span>

<span class="c1"># Drop constant columns</span>
<span class="n">df_sane</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">constant_cols</span><span class="p">)</span>

<span class="c1"># Save cleaned dataset for standardization step</span>
<span class="n">df_sane</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;gold_indicators_sanitized.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Saved sanitized dataset to &#39;gold_indicators_sanitized.csv&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🧾 Constant columns detected and removed: []
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ Saved sanitized dataset to &#39;gold_indicators_sanitized.csv&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="c1"># Reload sanitized data</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_indicators_sanitized.csv&quot;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">])</span>

<span class="c1"># Identify numeric columns (excluding time)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># Apply StandardScaler</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">df_scaled</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_scaled</span><span class="p">[</span><span class="n">features</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">features</span><span class="p">])</span>

<span class="c1"># Save result</span>
<span class="n">df_scaled</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;gold_indicators_standardized.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Standardization complete. Preview:&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">df_scaled</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ Standardization complete. Preview:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Local time</th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Volume</th>
      <th>EMA_9</th>
      <th>EMA_21</th>
      <th>EMA_50</th>
      <th>EMA_200</th>
      <th>MACD</th>
      <th>MACD_hist</th>
      <th>RSI_14</th>
      <th>ATR_14</th>
      <th>STDDEV_20</th>
      <th>ADX_14</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2020-01-01 23:35:00</td>
      <td>-1.355529</td>
      <td>-1.357007</td>
      <td>-1.354021</td>
      <td>-1.355516</td>
      <td>-1.004493</td>
      <td>-1.355557</td>
      <td>-1.355615</td>
      <td>-1.355752</td>
      <td>-1.35651</td>
      <td>-0.024411</td>
      <td>-0.000084</td>
      <td>4.243234</td>
      <td>-1.567265</td>
      <td>-1.062336</td>
      <td>-2.378793</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2020-01-01 23:40:00</td>
      <td>-1.355529</td>
      <td>-1.357007</td>
      <td>-1.354021</td>
      <td>-1.355516</td>
      <td>-1.004493</td>
      <td>-1.355557</td>
      <td>-1.355615</td>
      <td>-1.355752</td>
      <td>-1.35651</td>
      <td>-0.024411</td>
      <td>-0.000084</td>
      <td>4.243234</td>
      <td>-1.567265</td>
      <td>-1.062336</td>
      <td>-2.378793</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2020-01-01 23:45:00</td>
      <td>-1.355529</td>
      <td>-1.357007</td>
      <td>-1.354021</td>
      <td>-1.355516</td>
      <td>-1.004493</td>
      <td>-1.355557</td>
      <td>-1.355615</td>
      <td>-1.355752</td>
      <td>-1.35651</td>
      <td>-0.024411</td>
      <td>-0.000084</td>
      <td>4.243234</td>
      <td>-1.567265</td>
      <td>-1.062336</td>
      <td>-2.378793</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2020-01-01 23:50:00</td>
      <td>-1.355529</td>
      <td>-1.357007</td>
      <td>-1.354021</td>
      <td>-1.355516</td>
      <td>-1.004493</td>
      <td>-1.355557</td>
      <td>-1.355615</td>
      <td>-1.355752</td>
      <td>-1.35651</td>
      <td>-0.024411</td>
      <td>-0.000084</td>
      <td>4.243234</td>
      <td>-1.567265</td>
      <td>-1.062336</td>
      <td>-2.378793</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2020-01-01 23:55:00</td>
      <td>-1.355529</td>
      <td>-1.357007</td>
      <td>-1.354021</td>
      <td>-1.355516</td>
      <td>-1.004493</td>
      <td>-1.355557</td>
      <td>-1.355615</td>
      <td>-1.355752</td>
      <td>-1.35651</td>
      <td>-0.024411</td>
      <td>-0.000084</td>
      <td>4.243234</td>
      <td>-1.567265</td>
      <td>-1.062336</td>
      <td>-2.378793</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Load standardized dataset</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_indicators_sanitized.csv&quot;</span><span class="p">)</span>

<span class="c1"># Keep a copy of the timestamp for later</span>
<span class="n">timestamps</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">]</span>

<span class="c1"># Drop non-numeric columns for PCA</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">])</span>

<span class="c1"># Fit PCA</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">()</span>
<span class="n">X_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="c1"># Print explained variance</span>
<span class="n">explained_variance</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Explained Variance per Principal Component:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">explained_variance</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PC</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">var</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ Explained Variance per Principal Component:
PC1: 1.0000
PC2: 0.0000
PC3: 0.0000
PC4: 0.0000
PC5: 0.0000
PC6: 0.0000
PC7: 0.0000
PC8: 0.0000
PC9: 0.0000
PC10: 0.0000
PC11: 0.0000
PC12: 0.0000
PC13: 0.0000
PC14: 0.0000
PC15: 0.0000
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="feature-pipeline-indicator-enrichment-to-pca-compression">
<h1>Feature Pipeline: Indicator Enrichment to PCA Compression<a class="headerlink" href="#feature-pipeline-indicator-enrichment-to-pca-compression" title="Link to this heading">#</a></h1>
<p>This section builds a full preprocessing pipeline that transforms raw 5-minute gold midpoint data into a standardized,
compact feature space suitable for machine learning and regime modeling.
The pipeline starts with technical indicator extraction and ends with Principal Component Analysis (PCA) for dimensionality reduction.</p>
<section id="steps-performed">
<h2>Steps Performed<a class="headerlink" href="#steps-performed" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Indicator Engineering</strong>: We compute common trend, momentum, and volatility indicators using the <code class="docutils literal notranslate"><span class="pre">ta</span></code> library, including:</p>
<ul>
<li><p><strong>EMA (9, 21, 50, 200)</strong> for multi-timescale trends</p></li>
<li><p><strong>RSI (14)</strong> and <strong>MACD + Histogram</strong> for momentum strength</p></li>
<li><p><strong>ATR (14)</strong> and <strong>Rolling StdDev (20)</strong> for volatility</p></li>
<li><p><strong>ADX (14)</strong> to quantify directional strength</p></li>
</ul>
</li>
<li><p><strong>Sanity Check</strong>: We perform exploratory checks for missing values and low-variance (constant) features to clean the dataset.</p></li>
<li><p><strong>Standardization</strong>: All indicator columns are z-score standardized using <code class="docutils literal notranslate"><span class="pre">StandardScaler</span></code> to ensure comparability and compatibility with PCA.</p></li>
<li><p><strong>Dimensionality Reduction (PCA)</strong>: We apply PCA to the standardized dataset to identify orthogonal directions of highest variance.
The output includes principal components (PCs) and their explained variance ratios.</p></li>
</ul>
</section>
<section id="id1">
<h2>Mathematical Concepts Used<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Rolling Window Statistics</strong>: Used in StdDev and ATR calculations.</p></li>
<li><p><strong>Exponential Smoothing</strong>: Powers EMA and MACD logic.</p></li>
<li><p><strong>Z-score Normalization</strong>: Each feature is transformed by subtracting its mean and dividing by its standard deviation.</p></li>
<li><p><strong>Linear Algebra (PCA)</strong>: PCA decomposes the standardized feature matrix into eigenvectors and eigenvalues of its covariance matrix,
aligning axes with maximum variance directions.</p></li>
</ul>
<p>This foundation enables interpretable downstream tasks like regime detection and XGBoost classification,
using a decorrelated and compressed representation of the original indicator space.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">explained_variance</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Number of Principal Components&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cumulative Explained Variance&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Scree Plot - PCA Explained Variance&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;95% Threshold&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5488a3034e078dab813760ffbf7888faa9a6679a54b238fc1e5b24ee8a12e05c.png" src="_images/5488a3034e078dab813760ffbf7888faa9a6679a54b238fc1e5b24ee8a12e05c.png" />
</div>
</div>
</section>
</section>
<section id="pca-scree-plot-explained-variance-analysis">
<h1>PCA Scree Plot: Explained Variance Analysis<a class="headerlink" href="#pca-scree-plot-explained-variance-analysis" title="Link to this heading">#</a></h1>
<p>To evaluate how much variance each principal component retains from the standardized indicator dataset,
I use a scree plot to visualize the cumulative explained variance.
This helps determine the minimum number of components needed to preserve information while reducing dimensionality.</p>
<section id="interpretation">
<h2>Interpretation<a class="headerlink" href="#interpretation" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>The curve plateaus quickly, reaching nearly <strong>100% cumulative variance by the third component</strong>.</p></li>
<li><p>A <strong>horizontal red line at 95%</strong> serves as a benchmark — any number of components above this line retains at least 95% of the original variance.</p></li>
<li><p>From the plot, we can confidently select <strong>2–3 components</strong> to capture nearly all informational content of the original feature space.</p></li>
</ul>
</section>
<section id="id2">
<h2>Mathematical Concepts Used<a class="headerlink" href="#id2" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Eigen decomposition</strong>: PCA transforms the data using the eigenvectors of the covariance matrix.</p></li>
<li><p><strong>Variance preservation</strong>: Principal components are sorted by descending variance explained.</p></li>
<li><p><strong>Cumulative sum (<code class="docutils literal notranslate"><span class="pre">np.cumsum</span></code>)</strong>: Measures total information retained as more components are added.</p></li>
<li><p><strong>Dimensionality vs. Fidelity tradeoff</strong>: Balances model simplicity with data retention.</p></li>
</ul>
<p>This diagnostic step ensures we retain core market structure while simplifying the feature space for regime clustering or supervised learning.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save first 5 PCA columns as features</span>
<span class="n">pca_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_pca</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">5</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;PC</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)])</span>
<span class="n">pca_df</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamps</span>

<span class="c1"># Save to disk</span>
<span class="n">pca_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;gold_pca_features.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Saved PCA features to &#39;gold_pca_features.csv&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ Saved PCA features to &#39;gold_pca_features.csv&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Load sanitized data</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_indicators_sanitized.csv&quot;</span><span class="p">)</span>

<span class="c1"># Pick a few key indicators to visualize</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;EMA_9&#39;</span><span class="p">,</span> <span class="s1">&#39;MACD&#39;</span><span class="p">,</span> <span class="s1">&#39;RSI_14&#39;</span><span class="p">,</span> <span class="s1">&#39;ATR_14&#39;</span><span class="p">,</span> <span class="s1">&#39;STDDEV_20&#39;</span><span class="p">]</span>

<span class="c1"># Plot distribution</span>
<span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Indicator Time Series Preview&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Index&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Value&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1faed2beb7ffd07211979c9b7c12506a707620fe0f1b6373cc21c9fcf7c8f3c6.png" src="_images/1faed2beb7ffd07211979c9b7c12506a707620fe0f1b6373cc21c9fcf7c8f3c6.png" />
</div>
</div>
</section>
</section>
<section id="visual-preview-of-technical-indicators">
<h1>Visual Preview of Technical Indicators<a class="headerlink" href="#visual-preview-of-technical-indicators" title="Link to this heading">#</a></h1>
<p>In this chart, I plotted five of the core technical indicators across the full historical range of 5-minute gold data to get a rough sense of their time series behavior and scale.</p>
<section id="indicators-plotted">
<h2>Indicators Plotted<a class="headerlink" href="#indicators-plotted" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>EMA_9</strong>: Short-term exponential moving average of price.</p></li>
<li><p><strong>MACD</strong>: Measures trend momentum using fast and slow EMAs.</p></li>
<li><p><strong>RSI_14</strong>: Bounded oscillator reflecting recent gains vs. losses.</p></li>
<li><p><strong>ATR_14</strong>: Captures recent volatility via true range.</p></li>
<li><p><strong>STDDEV_20</strong>: Standard deviation over a rolling window of 20 bars.</p></li>
</ul>
</section>
<section id="interpretation-and-issue-observed">
<h2>Interpretation and Issue Observed<a class="headerlink" href="#interpretation-and-issue-observed" title="Link to this heading">#</a></h2>
<p>Although these indicators measure fundamentally different aspects of price behavior (trend, momentum, volatility), the chart reveals that many of them appear <strong>flattened or nearly overlapping</strong> at the bottom of the plot. This happens because indicators like <strong>EMA_9</strong> are on the same absolute scale as price (hundreds to thousands), while others like <strong>RSI</strong>, <strong>MACD</strong>, and <strong>ATR</strong> are on much smaller scales.</p>
<p>This lack of visible contrast signals a <strong>scaling issue</strong> and raises a deeper concern: without standardization, features with larger magnitudes (like EMA) will <strong>dominate</strong> any distance-based algorithms (e.g., PCA, clustering, KNN) or penalized regressions (like Ridge).</p>
</section>
<section id="what-this-means">
<h2>What This Means<a class="headerlink" href="#what-this-means" title="Link to this heading">#</a></h2>
<p>This chart makes it clear that I need to <strong>standardize</strong> or <strong>normalize</strong> the indicators before applying any further statistical or machine learning techniques. It also motivates a dimensionality reduction step like <strong>PCA</strong>, which will help decorrelate features and reduce redundancy among the indicators.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Count unique values in each feature column</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">🔍 Unique values per indicator:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;EMA_9&#39;</span><span class="p">,</span> <span class="s1">&#39;MACD&#39;</span><span class="p">,</span> <span class="s1">&#39;RSI_14&#39;</span><span class="p">,</span> <span class="s1">&#39;ATR_14&#39;</span><span class="p">,</span> <span class="s1">&#39;STDDEV_20&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🔍 Unique values per indicator:
EMA_9        359124
MACD         360474
RSI_14       348361
ATR_14       360474
STDDEV_20    357345
dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check how many rows have zero price movement</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Price_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span>
<span class="n">zero_movement_rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Price_range&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📉 Rows with zero price movement: </span><span class="si">{</span><span class="n">zero_movement_rows</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>📉 Rows with zero price movement: 12257 / 360550
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Load original dataset</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_with_indicators.csv&quot;</span><span class="p">)</span>

<span class="c1"># Select decorrelated indicator columns</span>
<span class="n">selected_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MACD&#39;</span><span class="p">,</span> <span class="s1">&#39;RSI_14&#39;</span><span class="p">,</span> <span class="s1">&#39;ATR_14&#39;</span><span class="p">,</span> <span class="s1">&#39;STDDEV_20&#39;</span><span class="p">,</span> <span class="s1">&#39;ADX_14&#39;</span><span class="p">]</span>
<span class="n">X_selected</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">selected_features</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Standardize</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_selected</span><span class="p">)</span>

<span class="c1"># Apply PCA</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">()</span>
<span class="n">X_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>

<span class="c1"># Explained variance ratio</span>
<span class="n">explained_variance</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span>

<span class="c1"># Save PCA-transformed data</span>
<span class="n">pca_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_pca</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PC</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X_pca</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
<span class="n">pca_df</span><span class="p">[</span><span class="s1">&#39;Local time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X_selected</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;Local time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">pca_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;gold_pca_selected_features.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Scree plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">explained_variance</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">explained_variance</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95% Threshold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Number of Principal Components&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cumulative Explained Variance&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Scree Plot - PCA (De-correlated Features)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/729c65a761fa98ed87c884a52f862741cca08ad97090e4b17dbbd7ba1d912257.png" src="_images/729c65a761fa98ed87c884a52f862741cca08ad97090e4b17dbbd7ba1d912257.png" />
</div>
</div>
</section>
</section>
<section id="pca-on-de-correlated-indicators">
<h1>🔍 PCA on De-correlated Indicators<a class="headerlink" href="#pca-on-de-correlated-indicators" title="Link to this heading">#</a></h1>
<p>After observing that certain features were heavily scale-dominated (e.g., EMA overshadowing others),
I focused PCA on a reduced set of technical indicators that are inherently more orthogonal and informative. This subset included:</p>
<ul class="simple">
<li><p><strong>MACD</strong></p></li>
<li><p><strong>RSI_14</strong></p></li>
<li><p><strong>ATR_14</strong></p></li>
<li><p><strong>STDDEV_20</strong></p></li>
<li><p><strong>ADX_14</strong></p></li>
</ul>
<p>Before running PCA, I confirmed the following:</p>
<ul class="simple">
<li><p>All selected indicators had sufficiently <strong>high uniqueness</strong> (many distinct values), which prevents PCA from overfitting on low-variance signals.</p></li>
<li><p>Very few rows had <strong>zero price range</strong> (i.e., <code class="docutils literal notranslate"><span class="pre">High</span> <span class="pre">==</span> <span class="pre">Low</span></code>), confirming that the market was rarely flat during these intervals,
ensuring informative indicator variation.</p></li>
</ul>
<section id="scree-plot-interpretation">
<h2>Scree Plot Interpretation<a class="headerlink" href="#scree-plot-interpretation" title="Link to this heading">#</a></h2>
<p>The scree plot shows how much cumulative variance each principal component captures. The key observation is:</p>
<ul class="simple">
<li><p><strong>3 principal components</strong> already explain over <strong>95% of the variance</strong>.</p></li>
<li><p>By <strong>PC5</strong>, nearly <strong>100% of the variance</strong> is retained.</p></li>
</ul>
<p>This tells me that the dimensionality of the indicator space can be confidently reduced from 5 to <strong>3 or fewer components</strong>,
without meaningful information loss. This step prepares the dataset for downstream modeling (e.g., clustering or regime detection) with <strong>fewer,
decorrelated dimensions</strong>, improving model generalization and interpretability.</p>
</section>
<section id="mathematical-justification">
<h2>Mathematical Justification<a class="headerlink" href="#mathematical-justification" title="Link to this heading">#</a></h2>
<p>PCA works by performing <strong>eigendecomposition</strong> of the covariance matrix (after standardization).
This rotates the feature space so that the new axes (principal components) are ordered by <strong>maximum variance captured</strong>.
By removing correlated or redundant indicators first, I ensured the PCA projection focused on orthogonal, informative components.</p>
<p>This step completes my feature compression workflow and sets the stage for regime modeling.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="c1"># Load the sanitized indicator dataset</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_indicators_sanitized.csv&quot;</span><span class="p">)</span>

<span class="c1"># Drop timestamp column and store column names</span>
<span class="n">feature_cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Local time&quot;</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">feature_cols</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Run PCA again to get loadings</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">()</span>
<span class="n">X_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="c1"># Create loadings DataFrame (eigenvectors)</span>
<span class="n">loadings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;PC</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_cols</span><span class="p">))],</span>
    <span class="n">index</span><span class="o">=</span><span class="n">feature_cols</span>
<span class="p">)</span>

<span class="c1"># Plot the top contributing features to PC1 and PC2</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">loadings</span><span class="p">[[</span><span class="s1">&#39;PC1&#39;</span><span class="p">,</span> <span class="s1">&#39;PC2&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;PCA Loadings – Contributions to PC1 and PC2&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Technical Indicator&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Loading Value&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 1200x600 with 0 Axes&gt;
</pre></div>
</div>
<img alt="_images/c4a6aad8e444ba9f11bc3f41ff35e9371dd4fa129f0ad2d3293bd7dca834d999.png" src="_images/c4a6aad8e444ba9f11bc3f41ff35e9371dd4fa129f0ad2d3293bd7dca834d999.png" />
</div>
</div>
</section>
</section>
<section id="pca-loadings-feature-contributions-to-pc1-and-pc2">
<h1>📊 PCA Loadings: Feature Contributions to PC1 and PC2<a class="headerlink" href="#pca-loadings-feature-contributions-to-pc1-and-pc2" title="Link to this heading">#</a></h1>
<p>In this step, I examined how each feature contributes to the principal components using PCA loadings.
PCA loadings represent the <strong>weights (or influence)</strong> each original feature has in constructing each principal component.
These loadings come from the <strong>eigenvectors</strong> of the standardized covariance matrix.</p>
<section id="observations-from-the-plot">
<h2>Observations from the Plot<a class="headerlink" href="#observations-from-the-plot" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>PC1 (blue bars)</strong> is dominated almost entirely by <code class="docutils literal notranslate"><span class="pre">Volume</span></code>. This means the <strong>first principal component is almost purely volume-driven</strong>,
and very little else contributes to it.</p></li>
<li><p><strong>PC2 (orange bars)</strong> spreads more evenly across multiple features:</p>
<ul>
<li><p>Price levels like <code class="docutils literal notranslate"><span class="pre">Open</span></code>, <code class="docutils literal notranslate"><span class="pre">High</span></code>, <code class="docutils literal notranslate"><span class="pre">Low</span></code>, <code class="docutils literal notranslate"><span class="pre">Close</span></code></p></li>
<li><p>Smoother trend-following EMAs (<code class="docutils literal notranslate"><span class="pre">EMA_9</span></code>, <code class="docutils literal notranslate"><span class="pre">EMA_21</span></code>, etc.)</p></li>
</ul>
</li>
</ul>
</section>
<section id="id3">
<h2>Interpretation<a class="headerlink" href="#id3" title="Link to this heading">#</a></h2>
<p>This tells me that:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Volume</span></code> behaves differently than all other indicators, capturing its own unique variance (likely spikes during high activity).</p></li>
<li><p>The rest of the features contribute similarly to PC2 — none dominate alone — which supports the idea that they are still
<strong>somewhat redundant or overlapping</strong>, even after sanitization.</p></li>
<li><p>Features like <code class="docutils literal notranslate"><span class="pre">MACD</span></code>, <code class="docutils literal notranslate"><span class="pre">RSI_14</span></code>, and <code class="docutils literal notranslate"><span class="pre">ATR_14</span></code> are barely contributing to PC1 or PC2, which might mean:</p>
<ul>
<li><p>Their variation lies in later components (PC3, PC4…),</p></li>
<li><p>Or they have low overall variance or importance in this transformed space.</p></li>
</ul>
</li>
</ul>
<p>This plot helps me understand <strong>which features dominate the variance structure</strong>, and helps justify whether to:</p>
<ul class="simple">
<li><p>Keep all features as-is,</p></li>
<li><p>Drop weak contributors, or</p></li>
<li><p>Create composite signals based on these loadings.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Load PCA features (should contain &#39;PC1&#39;, &#39;PC2&#39;, ...)</span>
<span class="n">pca_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_pca_features.csv&quot;</span><span class="p">)</span>

<span class="c1"># ✅ Create scatter plot of first two principal components</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pca_df</span><span class="p">[</span><span class="s1">&#39;PC1&#39;</span><span class="p">],</span> <span class="n">pca_df</span><span class="p">[</span><span class="s1">&#39;PC2&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;gold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;PC1 vs PC2 - Feature Space Projection&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Principal Component 1&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Principal Component 2&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/67c4d2407560508ca745edf0ff43c574254c0de39ca09332587d68c09c7bb5c7.png" src="_images/67c4d2407560508ca745edf0ff43c574254c0de39ca09332587d68c09c7bb5c7.png" />
</div>
</div>
</section>
</section>
<section id="pca-projection-feature-space-in-pc1-vs-pc2">
<h1>🎯 PCA Projection: Feature Space in PC1 vs PC2<a class="headerlink" href="#pca-projection-feature-space-in-pc1-vs-pc2" title="Link to this heading">#</a></h1>
<p>In this plot, I projected the dataset into the first two principal components (PC1 and PC2), giving me a visual snapshot of how the indicators distribute in a compressed 2D space.</p>
<section id="what-this-plot-shows">
<h2>What This Plot Shows<a class="headerlink" href="#what-this-plot-shows" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>PC1 (x-axis)</strong> captures the dominant variance direction, which I previously saw was almost entirely driven by <code class="docutils literal notranslate"><span class="pre">Volume</span></code>.</p></li>
<li><p><strong>PC2 (y-axis)</strong> captures the next most significant orthogonal direction — a mixture of price-based features like <code class="docutils literal notranslate"><span class="pre">Open</span></code>, <code class="docutils literal notranslate"><span class="pre">Close</span></code>, and EMAs.</p></li>
</ul>
</section>
<section id="id4">
<h2>Interpretation<a class="headerlink" href="#id4" title="Link to this heading">#</a></h2>
<p>The projection is <strong>heavily skewed to the left</strong>, meaning:</p>
<ul class="simple">
<li><p>Most data points cluster close to <strong>low PC1 values</strong>, confirming that for most of the time series, <code class="docutils literal notranslate"><span class="pre">Volume</span></code> doesn’t spike.</p></li>
<li><p>There are some <strong>outliers in PC1</strong> — high-volume events — that push a small number of points far to the right.</p></li>
<li><p>The <strong>spread in PC2</strong> is more even, showing that price indicators vary more steadily across time.</p></li>
</ul>
<p>This tells me that <strong>volume dominates the variance landscape</strong>, but doesn’t fluctuate frequently. Meanwhile, the other indicators still hold valuable variation — just not in the first component.</p>
</section>
<section id="why-this-matters">
<h2>Why This Matters<a class="headerlink" href="#why-this-matters" title="Link to this heading">#</a></h2>
<p>This 2D PCA projection is useful when:</p>
<ul class="simple">
<li><p>I want to visualize how <strong>distinct</strong> my features are in terms of signal contribution.</p></li>
<li><p>I’m preparing for dimensionality reduction or clustering.</p></li>
<li><p>I’m checking for <strong>non-linear structures</strong> (e.g. arcs, curves) that PCA might miss.</p></li>
</ul>
<p>This also reinforces what I saw earlier in the loadings plot: <code class="docutils literal notranslate"><span class="pre">Volume</span></code> is its own thing. Other features cluster around a more common structure, and I might need to combine or transform them to extract cleaner signals.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="c1"># Load the dataset you saved earlier in the working dir</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_with_indicators.csv&quot;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">])</span>

<span class="c1"># 1) Log‑transform Volume</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;log_volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">])</span>

<span class="c1"># 2) Drop original Volume &amp; time before PCA prep</span>
<span class="n">df_transformed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">,</span> <span class="s2">&quot;Local time&quot;</span><span class="p">])</span>

<span class="c1"># 3) Standardize all numeric features (including log_volume)</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">scaled_array</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df_transformed</span><span class="p">)</span>
<span class="n">scaled_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scaled_array</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">df_transformed</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

<span class="c1"># 4) Save the standardized, log‑volume dataset</span>
<span class="n">scaled_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;gold_indicators_logvol_standardized.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Preview</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Log‑volume transform + standardization complete:&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">scaled_df</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ Log‑volume transform + standardization complete:
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>EMA_9</th>
      <th>EMA_21</th>
      <th>EMA_50</th>
      <th>EMA_200</th>
      <th>MACD</th>
      <th>MACD_hist</th>
      <th>RSI_14</th>
      <th>ATR_14</th>
      <th>STDDEV_20</th>
      <th>ADX_14</th>
      <th>log_volume</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-1.355529</td>
      <td>-1.357007</td>
      <td>-1.354021</td>
      <td>-1.355516</td>
      <td>-1.355557</td>
      <td>-1.355615</td>
      <td>-1.355752</td>
      <td>-1.35651</td>
      <td>-0.024411</td>
      <td>-0.000084</td>
      <td>4.243234</td>
      <td>-1.567265</td>
      <td>-1.062336</td>
      <td>-2.378793</td>
      <td>-4.070743</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-1.355529</td>
      <td>-1.357007</td>
      <td>-1.354021</td>
      <td>-1.355516</td>
      <td>-1.355557</td>
      <td>-1.355615</td>
      <td>-1.355752</td>
      <td>-1.35651</td>
      <td>-0.024411</td>
      <td>-0.000084</td>
      <td>4.243234</td>
      <td>-1.567265</td>
      <td>-1.062336</td>
      <td>-2.378793</td>
      <td>-4.070743</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-1.355529</td>
      <td>-1.357007</td>
      <td>-1.354021</td>
      <td>-1.355516</td>
      <td>-1.355557</td>
      <td>-1.355615</td>
      <td>-1.355752</td>
      <td>-1.35651</td>
      <td>-0.024411</td>
      <td>-0.000084</td>
      <td>4.243234</td>
      <td>-1.567265</td>
      <td>-1.062336</td>
      <td>-2.378793</td>
      <td>-4.070743</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-1.355529</td>
      <td>-1.357007</td>
      <td>-1.354021</td>
      <td>-1.355516</td>
      <td>-1.355557</td>
      <td>-1.355615</td>
      <td>-1.355752</td>
      <td>-1.35651</td>
      <td>-0.024411</td>
      <td>-0.000084</td>
      <td>4.243234</td>
      <td>-1.567265</td>
      <td>-1.062336</td>
      <td>-2.378793</td>
      <td>-4.070743</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-1.355529</td>
      <td>-1.357007</td>
      <td>-1.354021</td>
      <td>-1.355516</td>
      <td>-1.355557</td>
      <td>-1.355615</td>
      <td>-1.355752</td>
      <td>-1.35651</td>
      <td>-0.024411</td>
      <td>-0.000084</td>
      <td>4.243234</td>
      <td>-1.567265</td>
      <td>-1.062336</td>
      <td>-2.378793</td>
      <td>-4.070743</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Load your base dataset with core indicators</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_with_indicators.csv&quot;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Local time&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># 1) Commodity Channel Index (CCI)</span>
<span class="n">tp</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;High&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Low&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">3</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;CCI_20&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span> <span class="o">-</span> <span class="n">tp</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.015</span> <span class="o">*</span> <span class="n">tp</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;CCI_10&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span> <span class="o">-</span> <span class="n">tp</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.015</span> <span class="o">*</span> <span class="n">tp</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>

<span class="c1"># 2) Bollinger Bandwidth</span>
<span class="n">bb_mid_20</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">bb_std_20</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;BBW_20&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">bb_std_20</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">bb_mid_20</span>

<span class="n">bb_mid_50</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">bb_std_50</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;BBW_50&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">bb_std_50</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">bb_mid_50</span>

<span class="c1"># 3) Vortex Indicator (VI+ / VI−)</span>
<span class="n">tr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;High&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Low&quot;</span><span class="p">],</span>
    <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;High&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span><span class="o">.</span><span class="n">abs</span><span class="p">(),</span>
    <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Low&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
<span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">vplus</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;High&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;High&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
<span class="n">vminus</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Low&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Low&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>

<span class="n">df</span><span class="p">[</span><span class="s2">&quot;VI_plus_14&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vplus</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">tr</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;VI_minus_14&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vminus</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">tr</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;VI_plus_21&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vplus</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">tr</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;VI_minus_21&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vminus</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">tr</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="c1"># 4) KST Oscillator</span>
<span class="k">def</span> <span class="nf">roc</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">series</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>

<span class="c1"># Default KST</span>
<span class="n">r1</span> <span class="o">=</span> <span class="n">roc</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">r2</span> <span class="o">=</span> <span class="n">roc</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">],</span> <span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">r3</span> <span class="o">=</span> <span class="n">roc</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">],</span> <span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">r4</span> <span class="o">=</span> <span class="n">roc</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">],</span> <span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;KST_10_15_20_30&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r1</span><span class="o">*</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r2</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">r3</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="n">r4</span><span class="o">*</span><span class="mi">4</span>

<span class="c1"># Alternative KST</span>
<span class="n">r1a</span> <span class="o">=</span> <span class="n">roc</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">],</span> <span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">r2a</span> <span class="o">=</span> <span class="n">roc</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">],</span> <span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">r3a</span> <span class="o">=</span> <span class="n">roc</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">],</span> <span class="mi">40</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">r4a</span> <span class="o">=</span> <span class="n">roc</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Close&quot;</span><span class="p">],</span> <span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;KST_20_30_40_50&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r1a</span><span class="o">*</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r2a</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">r3a</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="n">r4a</span><span class="o">*</span><span class="mi">4</span>

<span class="c1"># Reset index and save</span>
<span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;gold_with_new_decorrelated_indicators.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ New decorrelated indicators added and saved to &#39;gold_with_new_decorrelated_indicators.csv&#39;&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s2">&quot;CCI_20&quot;</span><span class="p">,</span><span class="s2">&quot;CCI_10&quot;</span><span class="p">,</span><span class="s2">&quot;BBW_20&quot;</span><span class="p">,</span><span class="s2">&quot;BBW_50&quot;</span><span class="p">,</span><span class="s2">&quot;VI_plus_14&quot;</span><span class="p">,</span><span class="s2">&quot;VI_minus_14&quot;</span><span class="p">,</span><span class="s2">&quot;VI_plus_21&quot;</span><span class="p">,</span><span class="s2">&quot;VI_minus_21&quot;</span><span class="p">,</span><span class="s2">&quot;KST_10_15_20_30&quot;</span><span class="p">,</span><span class="s2">&quot;KST_20_30_40_50&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ New decorrelated indicators added and saved to &#39;gold_with_new_decorrelated_indicators.csv&#39;
                     CCI_20  CCI_10  BBW_20  BBW_50  VI_plus_14  VI_minus_14  \
Local time                                                                     
2020-01-01 23:35:00     NaN     NaN     NaN     NaN         NaN          NaN   
2020-01-01 23:40:00     NaN     NaN     NaN     NaN         NaN          NaN   
2020-01-01 23:45:00     NaN     NaN     NaN     NaN         NaN          NaN   
2020-01-01 23:50:00     NaN     NaN     NaN     NaN         NaN          NaN   
2020-01-01 23:55:00     NaN     NaN     NaN     NaN         NaN          NaN   

                     VI_plus_21  VI_minus_21  KST_10_15_20_30  KST_20_30_40_50  
Local time                                                                      
2020-01-01 23:35:00         NaN          NaN              NaN              NaN  
2020-01-01 23:40:00         NaN          NaN              NaN              NaN  
2020-01-01 23:45:00         NaN          NaN              NaN              NaN  
2020-01-01 23:50:00         NaN          NaN              NaN              NaN  
2020-01-01 23:55:00         NaN          NaN              NaN              NaN  
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Peek after the maximum lookback (e.g., row 60+)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_with_new_decorrelated_indicators.csv&quot;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rows 60–70 (should have non‑NaNs):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">60</span><span class="p">:</span><span class="mi">70</span><span class="p">][[</span>
    <span class="s2">&quot;CCI_20&quot;</span><span class="p">,</span><span class="s2">&quot;CCI_10&quot;</span><span class="p">,</span><span class="s2">&quot;BBW_20&quot;</span><span class="p">,</span><span class="s2">&quot;BBW_50&quot;</span><span class="p">,</span>
    <span class="s2">&quot;VI_plus_14&quot;</span><span class="p">,</span><span class="s2">&quot;VI_minus_14&quot;</span><span class="p">,</span><span class="s2">&quot;VI_plus_21&quot;</span><span class="p">,</span><span class="s2">&quot;VI_minus_21&quot;</span><span class="p">,</span>
    <span class="s2">&quot;KST_10_15_20_30&quot;</span><span class="p">,</span><span class="s2">&quot;KST_20_30_40_50&quot;</span>
<span class="p">]])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Rows 60–70 (should have non‑NaNs):
    CCI_20  CCI_10  BBW_20  BBW_50  VI_plus_14  VI_minus_14  VI_plus_21  \
60     NaN     NaN     0.0     0.0         NaN          NaN         NaN   
61     NaN     NaN     0.0     0.0         NaN          NaN         NaN   
62     NaN     NaN     0.0     0.0         NaN          NaN         NaN   
63     NaN     NaN     0.0     0.0         NaN          NaN         NaN   
64     NaN     NaN     0.0     0.0         NaN          NaN         NaN   
65     NaN     NaN     0.0     0.0         NaN          NaN         NaN   
66     NaN     NaN     0.0     0.0         NaN          NaN         NaN   
67     NaN     NaN     0.0     0.0         NaN          NaN         NaN   
68     NaN     NaN     0.0     0.0         NaN          NaN         NaN   
69     NaN     NaN     0.0     0.0         NaN          NaN         NaN   

    VI_minus_21  KST_10_15_20_30  KST_20_30_40_50  
60          NaN              0.0              NaN  
61          NaN              0.0              NaN  
62          NaN              0.0              NaN  
63          NaN              0.0              NaN  
64          NaN              0.0              0.0  
65          NaN              0.0              0.0  
66          NaN              0.0              0.0  
67          NaN              0.0              0.0  
68          NaN              0.0              0.0  
69          NaN              0.0              0.0  
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="log-volume-transformation-decorrelated-indicator-engineering">
<h1>🧮 Log-Volume Transformation &amp; Decorrelated Indicator Engineering<a class="headerlink" href="#log-volume-transformation-decorrelated-indicator-engineering" title="Link to this heading">#</a></h1>
<p>In this section, I expand the feature set beyond the initial technical indicators by introducing new, potentially <strong>decorrelated indicators</strong>.
I also apply a <strong>logarithmic transformation to volume</strong>, followed by full standardization of the numeric feature space to prepare for dimensionality reduction and modeling.</p>
<section id="id5">
<h2>📌 Steps Performed<a class="headerlink" href="#id5" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Log-Transformed Volume</strong>:<br />
Applied <code class="docutils literal notranslate"><span class="pre">log1p</span></code> to reduce skewness in the raw volume distribution while preserving its dynamic range.<br />
This helps mitigate the heavy-tailed nature of volume data in financial time series.</p></li>
<li><p><strong>CCI (Commodity Channel Index)</strong>:<br />
Introduced CCI with 10 and 20-period lookbacks, which measures price deviation from a moving average baseline.</p></li>
<li><p><strong>Bollinger Bandwidth (BBW)</strong>:<br />
Computed the normalized width of the Bollinger Bands over 20 and 50 periods. This captures <strong>volatility compression/expansion</strong> rather
than directionality.</p></li>
<li><p><strong>Vortex Indicator (VI+ / VI−)</strong>:<br />
Added vortex components at 14 and 21 periods to capture the strength and direction of trend shifts, based on price highs/lows.</p></li>
<li><p><strong>KST Oscillator (Know Sure Thing)</strong>:<br />
Implemented two versions of KST with different long-range momentum structures.<br />
These combine multiple smoothed rate-of-change series to capture price cycles.</p></li>
<li><p><strong>Standardization</strong>:<br />
After adding the indicators, I dropped the timestamp and volume, then standardized all remaining columns using <code class="docutils literal notranslate"><span class="pre">StandardScaler</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Load expanded dataset</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_with_new_decorrelated_indicators.csv&quot;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">])</span>

<span class="c1"># Identify all indicator columns (exclude time and price)</span>
<span class="n">indicator_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">,</span> <span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Volume&quot;</span><span class="p">]]</span>

<span class="c1"># 1) Trim initial NaNs (warm‑up)</span>
<span class="n">df_trimmed</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">indicator_cols</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># 2) Clean infinities from division by zero</span>
<span class="n">df_trimmed</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_trimmed</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">indicator_cols</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ After cleaning, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_trimmed</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows remain&quot;</span><span class="p">)</span>

<span class="c1"># 3) Standardize</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df_trimmed</span><span class="p">[</span><span class="n">indicator_cols</span><span class="p">])</span>

<span class="c1"># 4) PCA on cleaned features</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">()</span>
<span class="n">X_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>
<span class="n">explained</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span>

<span class="c1"># 5) Scree plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">explained</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95% threshold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Number of PCs&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cumulative Explained Variance&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;PCA Scree Plot (Cleaned &amp; Expanded Indicators)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># 6) Save top 5 PCs</span>
<span class="n">pc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_pca</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">5</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;PC</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)])</span>
<span class="n">pc_df</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_trimmed</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">]</span>
<span class="n">pc_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;gold_pca_enhanced_clean.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Saved cleaned PCA features to &#39;gold_pca_enhanced_clean.csv&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ After cleaning, 354978 rows remain
</pre></div>
</div>
<img alt="_images/d866ec5f1bb02fb525d8fe3375b47a45da422f67c2ea60d03a0030fb251a721e.png" src="_images/d866ec5f1bb02fb525d8fe3375b47a45da422f67c2ea60d03a0030fb251a721e.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ Saved cleaned PCA features to &#39;gold_pca_enhanced_clean.csv&#39;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="pca-on-cleaned-expanded-indicators">
<h1>PCA on Cleaned + Expanded Indicators<a class="headerlink" href="#pca-on-cleaned-expanded-indicators" title="Link to this heading">#</a></h1>
<p>In this section, I apply PCA to the newly engineered dataset, which now includes both legacy and decorrelated indicators such as CCI, BBW, Vortex, and KST.
Before performing dimensionality reduction,I run data cleaning to remove NaNs and infinities resulting from indicator edge effects or divisions by zero.</p>
<section id="processing-steps">
<h2>Processing Steps<a class="headerlink" href="#processing-steps" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>NaN and ∞ Cleaning</strong>:<br />
Removed all rows with invalid indicator values caused by lookback warm-up or numerical instability (e.g., zero denominator in indicators like CCI and VI).</p></li>
<li><p><strong>Standardization</strong>:<br />
All indicator features are standardized using <code class="docutils literal notranslate"><span class="pre">StandardScaler</span></code> to ensure equal weighting across PCA.</p></li>
<li><p><strong>Principal Component Analysis</strong>:<br />
PCA is run on the cleaned and scaled features. I inspect the cumulative explained variance to determine how many principal components are needed to
retain the majority of information.</p></li>
</ul>
</section>
<section id="id6">
<h2>Scree Plot Interpretation<a class="headerlink" href="#id6" title="Link to this heading">#</a></h2>
<p>The scree plot shows that <strong>just under 10 principal components</strong> are needed to explain <strong>95% of the variance</strong>,
indicating a well-balanced reduction in dimensionality. This suggests the expanded indicator set contributes <strong>more diverse and orthogonal information</strong>
compared to the earlier highly redundant set.</p>
</section>
<section id="id7">
<h2>Mathematical Concepts Used<a class="headerlink" href="#id7" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Cumulative Explained Variance</strong>:<br />
The cumulative sum of the variance explained by each eigenvector (principal component) helps determine the cutoff point for dimensionality reduction.</p></li>
<li><p><strong>Dimensionality Compression</strong>:<br />
The PCA projection transforms correlated indicators into a smaller set of <strong>orthogonal components</strong>,
allowing me to reduce noise and redundancy in the feature space.</p></li>
</ul>
<p>I save the top 5 principal components as <code class="docutils literal notranslate"><span class="pre">gold_pca_enhanced_clean.csv</span></code>, ready for downstream modeling.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>

<span class="c1"># 1) Reload your standardized, trimmed dataset</span>
<span class="c1">#    (or directly reload the PCA object if you kept it in memory)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_indicators_logvol_standardized.csv&quot;</span><span class="p">)</span>

<span class="c1"># 2) Fit PCA again (or reuse your existing PCA instance)</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">()</span>
<span class="n">X_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>  <span class="c1"># df should be numeric features only</span>

<span class="c1"># 3) Compute cumulative explained variance</span>
<span class="n">cumulative_variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">)</span>

<span class="c1"># 4) Plot with integer ticks</span>
<span class="n">n_components</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cumulative_variance</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_components</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cumulative_variance</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Cumulative variance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95% Threshold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>         <span class="c1"># Show every integer component on the x-axis</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Number of Principal Components&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cumulative Explained Variance&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;PCA Scree Plot (Integer Component Steps)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4c5b5bb0fb6f4c02e66e040363a2c57f62c56b7d7547ee527f53906e7d7e8f0d.png" src="_images/4c5b5bb0fb6f4c02e66e040363a2c57f62c56b7d7547ee527f53906e7d7e8f0d.png" />
</div>
</div>
</section>
</section>
<section id="pca-on-standardized-features-with-log-volume">
<h1>🧮 PCA on Standardized Features with Log-Volume<a class="headerlink" href="#pca-on-standardized-features-with-log-volume" title="Link to this heading">#</a></h1>
<p>In this step, I apply PCA to the fully standardized indicator dataset that includes a log-transformed version of volume. Log-transforming the raw volume helps compress outliers and better align the volume distribution with the Gaussian assumptions behind PCA.</p>
<section id="process">
<h2>🔧 Process<a class="headerlink" href="#process" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Standardization</strong>:<br />
All features were already normalized using <code class="docutils literal notranslate"><span class="pre">StandardScaler</span></code> before applying PCA.</p></li>
<li><p><strong>Log-Transform on Volume</strong>:<br />
Since raw volume had a heavy right-skew, I applied <code class="docutils literal notranslate"><span class="pre">log1p(Volume)</span></code> to reduce variance distortion and emphasize relative changes in activity rather than absolute size.</p></li>
<li><p><strong>Cumulative Variance Tracking</strong>:<br />
I refitted PCA and plotted the cumulative explained variance at every principal component. The x-axis was adjusted to display every integer component to make variance jump behavior more visible.</p></li>
</ul>
</section>
<section id="id8">
<h2>📊 Scree Plot Interpretation<a class="headerlink" href="#id8" title="Link to this heading">#</a></h2>
<p>The curve shows that it takes around <strong>6–7 components</strong> to surpass the <strong>95% explained variance threshold</strong>, indicating that this new feature set has slightly more redundancy than the highly curated decorrelated set — but still provides strong coverage. The log-volume feature likely adds orthogonal variance that’s picked up by early components, but the rest of the technical indicators still carry overlapping information.</p>
<p>This helps confirm that log-volume may be an <strong>informative yet distinct</strong> feature from most price-based technical indicators.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># 1) Load the fully expanded indicators dataset</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_with_new_decorrelated_indicators.csv&quot;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">])</span>

<span class="c1"># 2) Drop any rows with NaN or infinite in any indicator column</span>
<span class="n">indicator_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">,</span> <span class="s2">&quot;Open&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;Close&quot;</span><span class="p">,</span> <span class="s2">&quot;Volume&quot;</span><span class="p">]]</span>
<span class="n">df_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">indicator_cols</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_clean</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_clean</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">indicator_cols</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># 3) Optionally, add log_volume if not already present</span>
<span class="n">df_clean</span><span class="p">[</span><span class="s2">&quot;log_volume&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">df_clean</span><span class="p">[</span><span class="s2">&quot;Volume&quot;</span><span class="p">])</span>
<span class="k">if</span> <span class="s2">&quot;Volume&quot;</span> <span class="ow">in</span> <span class="n">indicator_cols</span><span class="p">:</span>
    <span class="n">indicator_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;log_volume&quot;</span><span class="p">)</span>
    <span class="n">indicator_cols</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;Volume&quot;</span><span class="p">)</span>

<span class="c1"># 4) Standardize all selected features</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df_clean</span><span class="p">[</span><span class="n">indicator_cols</span><span class="p">])</span>

<span class="c1"># 5) Fit PCA once on the final feature matrix</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">()</span>
<span class="n">X_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">cumulative_variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">)</span>

<span class="c1"># 6) Plot with integer x‑ticks</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cumulative_variance</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cumulative_variance</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Cumulative Variance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95% Threshold&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Number of Principal Components&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cumulative Explained Variance&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Final PCA Scree Plot (Fully Expanded, Cleaned Features)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/b28f66baa8e291745b29367089a182333817674e827d0b4fae2c2f2bb3f24ecc.png" src="_images/b28f66baa8e291745b29367089a182333817674e827d0b4fae2c2f2bb3f24ecc.png" />
</div>
</div>
</section>
</section>
<section id="final-pca-scree-plot-fully-expanded-cleaned-features">
<h1>Final PCA Scree Plot – Fully Expanded &amp; Cleaned Features<a class="headerlink" href="#final-pca-scree-plot-fully-expanded-cleaned-features" title="Link to this heading">#</a></h1>
<p>This is the final PCA pass on the complete set of engineered indicators after rigorous preprocessing: NaNs removed, infinite values cleaned,
and <code class="docutils literal notranslate"><span class="pre">Volume</span></code> log-transformed into <code class="docutils literal notranslate"><span class="pre">log_volume</span></code>.</p>
<section id="pca-insights">
<h2>PCA Insights<a class="headerlink" href="#pca-insights" title="Link to this heading">#</a></h2>
<p>The scree plot shows that around <strong>9–10 principal components</strong> are enough to capture <strong>95% of the total variance</strong>, despite the large number of
input indicators. This confirms that:</p>
<ul class="simple">
<li><p>Many indicators carry <strong>overlapping or redundant</strong> information.</p></li>
<li><p>PCA helps me collapse the expanded feature space into a smaller set of orthogonal signals that preserve most of the variation.</p></li>
<li><p>After dimensionality reduction, I can feed only the top PCs into downstream models like logistic regression or tree ensembles.</p></li>
</ul>
</section>
<section id="takeaway">
<h2>Takeaway<a class="headerlink" href="#takeaway" title="Link to this heading">#</a></h2>
<p>This plot finalizes the dimensionality reduction phase of my pipeline. I now have a numerically clean, decorrelated,
compressed representation of my 5-minute XAU/USD indicator space — optimized for learning patterns without collinearity.</p>
<p>Next, I’ll analyze the <strong>PC loadings</strong> and <strong>scatter projection</strong>, then feed these components into a classifier to predict future price movement direction.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Load your final PCA feature set</span>
<span class="n">pc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_pca_enhanced_clean.csv&quot;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">])</span>

<span class="c1"># Load original enriched data to get Close price and ATR_14</span>
<span class="n">orig</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_with_new_decorrelated_indicators.csv&quot;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">])</span>

<span class="c1"># Merge on Local time</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pc_df</span><span class="p">,</span> <span class="n">orig</span><span class="p">[[</span><span class="s1">&#39;Local time&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">,</span> <span class="s1">&#39;ATR_14&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Local time&quot;</span><span class="p">)</span>

<span class="c1"># Scatter PC1 vs PC2</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;PC1&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;PC2&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;PC1 vs PC2 Projection&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;PC1&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;PC2&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c213e4641804a3008461219c184f60367c53d4307b49dbd1de6ef31bbf7b9f6b.png" src="_images/c213e4641804a3008461219c184f60367c53d4307b49dbd1de6ef31bbf7b9f6b.png" />
</div>
</div>
</section>
</section>
<section id="pca-projection-pc1-vs-pc2-scatter">
<h1>PCA Projection: PC1 vs PC2 Scatter<a class="headerlink" href="#pca-projection-pc1-vs-pc2-scatter" title="Link to this heading">#</a></h1>
<p>In this cell, I projected the full set of standardized technical indicators onto the first two principal components, PC1 and PC2.
These components were derived from the fully cleaned and expanded feature set, including momentum, trend, volatility, and volume-transformed indicators.</p>
<section id="visual-interpretation">
<h2>Visual Interpretation<a class="headerlink" href="#visual-interpretation" title="Link to this heading">#</a></h2>
<p>The scatter plot shows a dense, elliptical cloud centered near the origin with moderate horizontal spread along PC1 and
a more compressed vertical spread along PC2. This suggests:</p>
<ul class="simple">
<li><p><strong>PC1 captures most of the total variance</strong> in the dataset, especially variations likely tied to dominant market behaviors such as volatility and
log-volume.</p></li>
<li><p><strong>PC2 contributes additional but smaller variance</strong>, potentially linked to secondary dynamics such as oscillators (e.g., RSI, CCI) or trend interactions.</p></li>
</ul>
<p>There are outlier streaks extending far along the PC1 axis, possibly indicating rare but high-impact market conditions
(such as breakout volatility or volume spikes).</p>
</section>
<section id="mathematical-implication">
<h2>Mathematical Implication<a class="headerlink" href="#mathematical-implication" title="Link to this heading">#</a></h2>
<p>Since PCA components are orthogonal, this 2D projection provides a compressed but uncorrelated view of the multidimensional indicator space.
It allows me to assess whether major patterns in the dataset cluster or disperse across regimes,
which can inform later modeling or regime segmentation tasks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># Lookahead window (bars)</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1"># Compute forward return</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;fut_ret&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="p">)</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

<span class="c1"># Binary target: 1 if return &gt; 0, else 0</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;fut_ret&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Drop last h rows with NaN target</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Features: first 5 PCs</span>
<span class="n">pc_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;PC</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>

<span class="c1"># Train/test split (70/30)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="n">pc_cols</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">],</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training samples:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">),</span> <span class="s2">&quot;Testing samples:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training samples: 248481 Testing samples: 106493
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">roc_curve</span>

<span class="c1"># Train</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Predict probabilities</span>
<span class="n">y_prob</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># Compute ROC‑AUC</span>
<span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Logistic Regression ROC‑AUC: </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Optional: plot ROC curve</span>
<span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;AUC = </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;False Positive Rate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;True Positive Rate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;ROC Curve&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>✅ Logistic Regression ROC‑AUC: 0.4894
</pre></div>
</div>
<img alt="_images/b24e53133487fdc9b87f68992ad6121ccf2c7e5938e4d7ff946335154802cbb0.png" src="_images/b24e53133487fdc9b87f68992ad6121ccf2c7e5938e4d7ff946335154802cbb0.png" />
</div>
</div>
</section>
</section>
<section id="logistic-regression-on-pca-components-rocauc-evaluation">
<h1>Logistic Regression on PCA Components: ROC‑AUC Evaluation<a class="headerlink" href="#logistic-regression-on-pca-components-rocauc-evaluation" title="Link to this heading">#</a></h1>
<p>In this cell, I trained a logistic regression model using the first five principal components (PC1–PC5) as features,
aiming to predict the direction of the forward 3-bar return on XAU/USD. The binary target was defined as 1 for positive return and 0 otherwise.</p>
<section id="model-setup">
<h2>Model Setup<a class="headerlink" href="#model-setup" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Features:</strong> Top 5 principal components (from PCA on decorrelated indicators)</p></li>
<li><p><strong>Target:</strong> 3-bar forward return direction</p></li>
<li><p><strong>Split:</strong> 70% training, 30% testing (time‑ordered, no shuffle)</p></li>
<li><p><strong>Model:</strong> Logistic Regression</p></li>
<li><p><strong>Metric:</strong> ROC‑AUC</p></li>
</ul>
</section>
<section id="results-and-interpretation">
<h2>Results and Interpretation<a class="headerlink" href="#results-and-interpretation" title="Link to this heading">#</a></h2>
<p>The ROC curve for this model yielded an <strong>AUC of 0.489</strong>, which is <strong>worse than random chance (0.5)</strong>. The ROC curve closely follows the diagonal,
indicating that the model has <strong>no discriminatory power</strong> between upward and downward future moves based on the PCA features alone.</p>
</section>
<section id="id9">
<h2>Takeaway<a class="headerlink" href="#id9" title="Link to this heading">#</a></h2>
<p>This result suggests that:</p>
<ul class="simple">
<li><p>PCA features alone are <strong>not sufficient for directional prediction</strong>, possibly due to loss of interpretability or nonlinear interactions.</p></li>
<li><p>Additional feature sets (e.g. raw indicators, regime context, event markers) or nonlinear models (e.g. tree‑based, neural nets) may be needed.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Prepare full-series probabilities and align with ATR &amp; price</span>
<span class="n">df_back</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">):]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob_up&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_prob</span>
<span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;ATR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]</span>

<span class="c1"># Signal: go long when prob_up &gt; 0.6</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.6</span>
<span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob_up&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">alpha</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Compute R-multiple for each signal event</span>
<span class="n">R_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_back</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">entry_price</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">exit_price</span>  <span class="o">=</span> <span class="n">df_back</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_back</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">risk</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ATR&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">exit_price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">risk</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">R_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">exit_price</span> <span class="o">-</span> <span class="n">entry_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">risk</span><span class="p">)</span>

<span class="c1"># Metrics</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R_list</span><span class="p">)</span>
<span class="n">win_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">R</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">avg_R</span>    <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">sharpe_R</span> <span class="o">=</span> <span class="n">avg_R</span> <span class="o">/</span> <span class="n">R</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Backtest over </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="si">}</span><span class="s2"> trades:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; • Win rate:     </span><span class="si">{</span><span class="n">win_rate</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; • Avg R‑mult:   </span><span class="si">{</span><span class="n">avg_R</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; • Sharpe (R):   </span><span class="si">{</span><span class="n">sharpe_R</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># R‑multiple histogram</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;R‑Multiple Distribution&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Backtest over 0 trades:
 • Win rate:     nan%
 • Avg R‑mult:   nan
 • Sharpe (R):   nan
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Anaconda\Lib\site-packages\numpy\core\fromnumeric.py:3504: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
C:\Anaconda\Lib\site-packages\numpy\core\_methods.py:129: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
C:\Users\K T\AppData\Local\Temp\ipykernel_8096\1982879996.py:23: RuntimeWarning: Mean of empty slice.
  avg_R    = R.mean()
C:\Anaconda\Lib\site-packages\numpy\core\_methods.py:206: RuntimeWarning: Degrees of freedom &lt;= 0 for slice
  ret = _var(a, axis=axis, dtype=dtype, out=out, ddof=ddof,
C:\Anaconda\Lib\site-packages\numpy\core\_methods.py:163: RuntimeWarning: invalid value encountered in divide
  arrmean = um.true_divide(arrmean, div, out=arrmean,
C:\Anaconda\Lib\site-packages\numpy\core\_methods.py:198: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
</pre></div>
</div>
<img alt="_images/77673523b3b741a4aedcbdcd93000dd9bd4695bf9459be0b3366ba2bebc33c91.png" src="_images/77673523b3b741a4aedcbdcd93000dd9bd4695bf9459be0b3366ba2bebc33c91.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">y_prob</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Distribution of Predicted Probabilities&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;P(up)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8e4c9dcb57e2cc6c8ff3a6c8db9a030af9acb35cb89327c67cf3e54aba9ded6d.png" src="_images/8e4c9dcb57e2cc6c8ff3a6c8db9a030af9acb35cb89327c67cf3e54aba9ded6d.png" />
</div>
</div>
</section>
</section>
<section id="prediction-confidence-check-histogram-of-logistic-regression-probabilities">
<h1>Prediction Confidence Check: Histogram of Logistic Regression Probabilities<a class="headerlink" href="#prediction-confidence-check-histogram-of-logistic-regression-probabilities" title="Link to this heading">#</a></h1>
<p>In this cell, I visualize the distribution of predicted probabilities from my logistic regression model that was trained on the top 5 principal components of the gold indicator dataset.</p>
<section id="purpose">
<h2>Purpose<a class="headerlink" href="#purpose" title="Link to this heading">#</a></h2>
<p>This plot helps me evaluate <strong>how confident the model is</strong> when predicting the probability that price will increase in the next 3 bars.</p>
</section>
<section id="id10">
<h2>Interpretation<a class="headerlink" href="#id10" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>The distribution is tightly clustered between <strong>0.48 and 0.50</strong>, forming a sharp bell curve centered around 0.49.</p></li>
<li><p>This means the model produces outputs <strong>very close to random guessing</strong> (a flat 50/50 coin flip).</p></li>
<li><p>There are almost <strong>no probabilities above 0.6</strong>, which is why <strong>the backtest using a 0.6 threshold triggered 0 trades</strong>.</p></li>
</ul>
</section>
<section id="implications">
<h2>Implications<a class="headerlink" href="#implications" title="Link to this heading">#</a></h2>
<p>This low-confidence output confirms the poor ROC-AUC score (0.489) and suggests that:</p>
<ul class="simple">
<li><p>Either the features (PC1 to PC5) <strong>do not capture signal</strong>, or</p></li>
<li><p>The logistic regression model is <strong>too simple or linear</strong> to extract signal from those features.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">roc_curve</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># 1) Load 5‑PC features + price/ATR</span>
<span class="n">pc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_pca_enhanced_clean.csv&quot;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">])</span>
<span class="n">orig</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_with_new_decorrelated_indicators.csv&quot;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">])</span>
<span class="n">df</span>    <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pc_df</span><span class="p">,</span> <span class="n">orig</span><span class="p">[[</span><span class="s1">&#39;Local time&#39;</span><span class="p">,</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Local time&quot;</span><span class="p">)</span>

<span class="c1"># 2) New horizon</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;fut_ret_2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="p">)</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;target_2&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;fut_ret_2&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># 3) Train/test split</span>
<span class="n">pc_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;PC</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="n">pc_cols</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target_2&#39;</span><span class="p">],</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>

<span class="c1"># 4) Fit model &amp; ROC‑AUC</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">y_prob</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">auc</span>    <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;2‑Bar Logistic Regression ROC‑AUC: </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 5) Plot ROC curve</span>
<span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;AUC = </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;False Positive Rate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;True Positive Rate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;ROC Curve (2‑Bar Horizon)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2‑Bar Logistic Regression ROC‑AUC: 0.5602
</pre></div>
</div>
<img alt="_images/81e842199db034ddf2ab36b750f582f987a3fb93a82890be74da3b5c66177ec2.png" src="_images/81e842199db034ddf2ab36b750f582f987a3fb93a82890be74da3b5c66177ec2.png" />
</div>
</div>
</section>
</section>
<section id="logistic-regression-on-pca-features-2-bar-roc-auc-evaluation">
<h1>Logistic Regression on PCA Features: 2-Bar ROC-AUC Evaluation<a class="headerlink" href="#logistic-regression-on-pca-features-2-bar-roc-auc-evaluation" title="Link to this heading">#</a></h1>
<p>In this cell, I train a logistic regression model on the <strong>top 5 principal components (PC1–PC5)</strong> derived from standardized technical indicators on
5-minute XAU/USD data. The binary classification task is to predict whether the price will increase over the next 2 bars.</p>
<section id="id11">
<h2>Model Setup<a class="headerlink" href="#id11" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Features:</strong> PC1 to PC5 (from PCA on domain-informed indicators)</p></li>
<li><p><strong>Target:</strong> <code class="docutils literal notranslate"><span class="pre">target_2</span></code> = 1 if price goes up over next 2 bars, 0 otherwise</p></li>
<li><p><strong>Horizon:</strong> 2-bar forward return</p></li>
<li><p><strong>Split:</strong> 70% train, 30% test (chronologically split, no shuffle)</p></li>
<li><p><strong>Model:</strong> Logistic Regression</p></li>
<li><p><strong>Metric:</strong> ROC-AUC</p></li>
</ul>
</section>
<section id="id12">
<h2>Results and Interpretation<a class="headerlink" href="#id12" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>The model yields a <strong>ROC-AUC of 0.5602</strong>, which is <strong>marginally better than random (0.5)</strong>.</p></li>
<li><p>The ROC curve slightly bows above the diagonal baseline, indicating <strong>weak discriminatory power</strong>.</p></li>
<li><p>The model is able to <strong>separate classes slightly</strong>, but not enough to produce a robust directional signal.</p></li>
<li><p>No threshold yields a steep improvement in TPR over FPR — suggesting <strong>a shallow ranking of probabilities</strong> across classes.</p></li>
</ul>
</section>
<section id="id13">
<h2>Implications<a class="headerlink" href="#id13" title="Link to this heading">#</a></h2>
<p>This weak performance may indicate:</p>
<ul class="simple">
<li><p>The <strong>PCA transformation may be discarding nonlinear structure</strong> necessary for separating regimes in XAU/USD.</p></li>
<li><p>Logistic regression’s linear nature might be insufficient to <strong>capture latent interactions</strong> between components.</p></li>
<li><p>The 2-bar horizon may be <strong>too noisy or too short</strong> for directional edge to manifest via compression of indicators.</p></li>
</ul>
</section>
<section id="id14">
<h2>Takeaway<a class="headerlink" href="#id14" title="Link to this heading">#</a></h2>
<p>While the result is not entirely random, the signal extracted from PCA features remains <strong>statistically fragile and economically doubtful</strong>.
AUC of 0.56 does not translate into a profitable trading edge once <strong>transaction costs and execution slippage</strong> are considered.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Histogram of predicted probabilities</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">y_prob</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;2‑Bar Horizon Predicted Probabilities&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;P(up)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/14b6ecdad05001709ac807ca59ce5c40964a272de546993aae3656fc98d2c64d.png" src="_images/14b6ecdad05001709ac807ca59ce5c40964a272de546993aae3656fc98d2c64d.png" />
</div>
</div>
</section>
</section>
<section id="predicted-probability-histogram-2-bar-horizon">
<h1>Predicted Probability Histogram (2-Bar Horizon)<a class="headerlink" href="#predicted-probability-histogram-2-bar-horizon" title="Link to this heading">#</a></h1>
<p>This plot shows the distribution of <code class="docutils literal notranslate"><span class="pre">P(up)</span></code> from the logistic regression model trained on PCA features for XAU/USD.</p>
<section id="id15">
<h2>Interpretation<a class="headerlink" href="#id15" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Predictions are tightly clustered around <strong>0.49</strong>, forming a narrow bell curve.</p></li>
<li><p>The model avoids confident forecasts — <strong>rarely exceeding 0.52</strong> or dropping below 0.46.</p></li>
<li><p>This reflects <strong>low model entropy</strong> and confirms minimal separation between classes.</p></li>
</ul>
</section>
<section id="implication">
<h2>Implication<a class="headerlink" href="#implication" title="Link to this heading">#</a></h2>
<p>Despite an ROC-AUC of 0.5602, the model is <strong>not practically usable</strong>:</p>
<ul class="simple">
<li><p>No actionable threshold exists (e.g., P &gt; 0.6 triggers 0 trades).</p></li>
<li><p>The PCA-logit pipeline lacks <strong>confidence calibration</strong> and fails to extract sharp directional signals.</p></li>
</ul>
</section>
<section id="id16">
<h2>Takeaway<a class="headerlink" href="#id16" title="Link to this heading">#</a></h2>
<p>The model is <strong>statistically marginal</strong>, but <strong>operationally inert</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.52</span><span class="p">,</span> <span class="mf">0.54</span><span class="p">,</span> <span class="mf">0.56</span><span class="p">,</span> <span class="mf">0.58</span><span class="p">]:</span>
    <span class="n">n_trades</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_prob</span> <span class="o">&gt;</span> <span class="n">alpha</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Threshold </span><span class="si">{</span><span class="n">alpha</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">n_trades</span><span class="si">}</span><span class="s2"> trades&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Threshold 0.52: 1077 trades
Threshold 0.54: 322 trades
Threshold 0.56: 79 trades
Threshold 0.58: 4 trades
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Reload merged DataFrame (aligned with y_prob and ATR)</span>
<span class="n">pc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_pca_enhanced_clean.csv&quot;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">])</span>
<span class="n">orig</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_with_new_decorrelated_indicators.csv&quot;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">])</span>
<span class="n">df_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pc_df</span><span class="p">,</span> <span class="n">orig</span><span class="p">[[</span><span class="s1">&#39;Local time&#39;</span><span class="p">,</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Local time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">):</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># y_prob is from your logistic regression on the test set</span>
<span class="c1"># Ensure y_prob aligns: length should match df_all</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_prob</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_all</span><span class="p">)</span>

<span class="n">df_all</span><span class="p">[</span><span class="s1">&#39;prob_up&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_prob</span>

<span class="k">def</span> <span class="nf">backtest_at</span><span class="p">(</span><span class="n">alpha</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df_all</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;prob_up&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">alpha</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">R_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># 2-bar horizon</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
            <span class="n">exit</span>  <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="n">h</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">risk</span>  <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">exit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">risk</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">R_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">exit</span> <span class="o">-</span> <span class="n">entry</span><span class="p">)</span> <span class="o">/</span> <span class="n">risk</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R_list</span><span class="p">)</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">,</span>
        <span class="s1">&#39;n_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">),</span>
        <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">R</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="s1">&#39;avg_R&#39;</span><span class="p">:</span> <span class="n">R</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="s1">&#39;sharpe_R&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">R</span><span class="o">.</span><span class="n">std</span><span class="p">())</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="p">}</span>
    <span class="c1"># Plot histogram</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R‑Multiple Histogram (α=</span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s2">, trades=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">metrics</span>

<span class="c1"># Backtest at two thresholds</span>
<span class="n">metrics_52</span> <span class="o">=</span> <span class="n">backtest_at</span><span class="p">(</span><span class="mf">0.52</span><span class="p">)</span>
<span class="n">metrics_54</span> <span class="o">=</span> <span class="n">backtest_at</span><span class="p">(</span><span class="mf">0.54</span><span class="p">)</span>

<span class="c1"># Display results</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">metrics_52</span><span class="p">,</span> <span class="n">metrics_54</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/11be502e2c9e516efb8efebf64482d946231c80f5090838839aec9472bcb7e61.png" src="_images/11be502e2c9e516efb8efebf64482d946231c80f5090838839aec9472bcb7e61.png" />
<img alt="_images/f4f6c8d580118bde56ace62f33cd4b250a3385cd36e5c7e82e1c30c4450025eb.png" src="_images/f4f6c8d580118bde56ace62f33cd4b250a3385cd36e5c7e82e1c30c4450025eb.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   alpha  n_trades  win_rate     avg_R  sharpe_R
0   0.52      1077  0.521820  0.051690  0.051238
1   0.54       322  0.481366  0.054096  0.056079
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="backtest-results-r-multiple-distributions-by-threshold">
<h1>Backtest Results: R-Multiple Distributions by Threshold<a class="headerlink" href="#backtest-results-r-multiple-distributions-by-threshold" title="Link to this heading">#</a></h1>
<p>These plots show R-multiple outcomes from trades filtered by <code class="docutils literal notranslate"><span class="pre">P(up)</span> <span class="pre">&gt;</span> <span class="pre">α</span></code> using the logistic regression model.</p>
<section id="id17">
<h2>Interpretation<a class="headerlink" href="#id17" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>At <strong>α = 0.52</strong>:</p>
<ul>
<li><p>1077 trades triggered</p></li>
<li><p>Sharpe ≈ <strong>0.051</strong></p></li>
<li><p>Distribution is wide but skewed left; <strong>many small losses</strong>, few large wins</p></li>
</ul>
</li>
<li><p>At <strong>α = 0.54</strong>:</p>
<ul>
<li><p>Trade count drops to 322</p></li>
<li><p>Sharpe slightly improves to <strong>0.056</strong></p></li>
<li><p>Distribution still lacks edge — no consistent positive skew</p></li>
</ul>
</li>
</ul>
</section>
<section id="id18">
<h2>Takeaway<a class="headerlink" href="#id18" title="Link to this heading">#</a></h2>
<p>The model’s probabilities are <strong>too weakly ranked</strong> to separate profitable trades. Even with elevated thresholds,
the resulting Sharpe remains near zero. Signal quality is <strong>not economically actionable</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span>

<span class="c1"># —— Use existing in‑memory data ——  </span>
<span class="c1"># X_train, X_test, y_train, y_test are already defined  </span>
<span class="c1"># And y_prob from logistic was for baseline</span>

<span class="c1"># 1) Train Random Forest on the same 5 PCs + candle features (if defined)</span>
<span class="c1"># If you added candlestick patterns into X_train, great; otherwise:</span>
<span class="c1"># feature_cols = [f&quot;PC{i+1}&quot; for i in range(5)]</span>
<span class="c1"># X_train, X_test already include these columns.</span>

<span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># 2) Predict probabilities on the test set</span>
<span class="n">y_prob_rf</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># 3) Compute ROC‑AUC</span>
<span class="n">auc_rf</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_prob_rf</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Random Forest ROC‑AUC: </span><span class="si">{</span><span class="n">auc_rf</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 4) (Optional) Compare with your logistic baseline</span>
<span class="c1"># print(f&quot;Logistic ROC‑AUC: {auc_logistic:.4f}&quot;)  # if you stored it</span>

<span class="c1"># 5) Feature Importances (for PCs)</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">importances</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">rf</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">importances</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;RF Feature Importances&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">34</span><span class="p">],</span> <span class="n">line</span> <span class="mi">14</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="c1"># —— Use existing in‑memory data ——  </span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="c1"># X_train, X_test, y_train, y_test are already defined  </span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="c1"># And y_prob from logistic was for baseline</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="c1"># feature_cols = [f&quot;PC{i+1}&quot; for i in range(5)]</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="c1"># X_train, X_test already include these columns.</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">14</span> <span class="n">rf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">16</span> <span class="c1"># 2) Predict probabilities on the test set</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span> <span class="n">y_prob_rf</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="nn">File C:\Anaconda\Lib\site-packages\sklearn\base.py:1473,</span> in <span class="ni">_fit_context.&lt;locals&gt;.decorator.&lt;locals&gt;.wrapper</span><span class="nt">(estimator, *args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1466</span>     <span class="n">estimator</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">()</span>
<span class="g g-Whitespace">   </span><span class="mi">1468</span> <span class="k">with</span> <span class="n">config_context</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1469</span>     <span class="n">skip_parameter_validation</span><span class="o">=</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1470</span>         <span class="n">prefer_skip_nested_validation</span> <span class="ow">or</span> <span class="n">global_skip_validation</span>
<span class="g g-Whitespace">   </span><span class="mi">1471</span>     <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1472</span> <span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1473</span>     <span class="k">return</span> <span class="n">fit_method</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">File C:\Anaconda\Lib\site-packages\sklearn\ensemble\_forest.py:489,</span> in <span class="ni">BaseForest.fit</span><span class="nt">(self, X, y, sample_weight)</span>
<span class="g g-Whitespace">    </span><span class="mi">478</span> <span class="n">trees</span> <span class="o">=</span> <span class="p">[</span>
<span class="g g-Whitespace">    </span><span class="mi">479</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_make_estimator</span><span class="p">(</span><span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
<span class="nn">    480     for i</span> in <span class="ni">range</span><span class="nt">(n_more_estimators)</span>
<span class="g g-Whitespace">    </span><span class="mi">481</span> <span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">483</span> <span class="c1"># Parallel loop: we prefer the threading backend as the Cython code</span>
<span class="g g-Whitespace">    </span><span class="mi">484</span> <span class="c1"># for fitting the trees is internally releasing the Python GIL</span>
<span class="g g-Whitespace">    </span><span class="mi">485</span> <span class="c1"># making threading more efficient than multiprocessing in</span>
<span class="g g-Whitespace">    </span><span class="mi">486</span> <span class="c1"># that case. However, for joblib 0.12+ we respect any</span>
<span class="g g-Whitespace">    </span><span class="mi">487</span> <span class="c1"># parallel_backend contexts set at a higher level,</span>
<span class="g g-Whitespace">    </span><span class="mi">488</span> <span class="c1"># since correctness does not rely on using threads.</span>
<span class="ne">--&gt; </span><span class="mi">489</span> <span class="n">trees</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">490</span>     <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">491</span>     <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">492</span>     <span class="n">prefer</span><span class="o">=</span><span class="s2">&quot;threads&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span> <span class="p">)(</span>
<span class="g g-Whitespace">    </span><span class="mi">494</span>     <span class="n">delayed</span><span class="p">(</span><span class="n">_parallel_build_trees</span><span class="p">)(</span>
<span class="g g-Whitespace">    </span><span class="mi">495</span>         <span class="n">t</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">496</span>         <span class="bp">self</span><span class="o">.</span><span class="n">bootstrap</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">497</span>         <span class="n">X</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">498</span>         <span class="n">y</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">499</span>         <span class="n">sample_weight</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">500</span>         <span class="n">i</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">501</span>         <span class="nb">len</span><span class="p">(</span><span class="n">trees</span><span class="p">),</span>
<span class="g g-Whitespace">    </span><span class="mi">502</span>         <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">503</span>         <span class="n">class_weight</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">class_weight</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">504</span>         <span class="n">n_samples_bootstrap</span><span class="o">=</span><span class="n">n_samples_bootstrap</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">505</span>         <span class="n">missing_values_in_feature_mask</span><span class="o">=</span><span class="n">missing_values_in_feature_mask</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">506</span>     <span class="p">)</span>
<span class="nn">    507     for i, t</span> in <span class="ni">enumerate</span><span class="nt">(trees)</span>
<span class="g g-Whitespace">    </span><span class="mi">508</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">510</span> <span class="c1"># Collect newly grown trees</span>
<span class="g g-Whitespace">    </span><span class="mi">511</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimators_</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">trees</span><span class="p">)</span>

<span class="nn">File C:\Anaconda\Lib\site-packages\sklearn\utils\parallel.py:74,</span> in <span class="ni">Parallel.__call__</span><span class="nt">(self, iterable)</span>
<span class="g g-Whitespace">     </span><span class="mi">69</span> <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">70</span> <span class="n">iterable_with_config</span> <span class="o">=</span> <span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">71</span>     <span class="p">(</span><span class="n">_with_config</span><span class="p">(</span><span class="n">delayed_func</span><span class="p">,</span> <span class="n">config</span><span class="p">),</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">72</span>     <span class="k">for</span> <span class="n">delayed_func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="n">iterable</span>
<span class="g g-Whitespace">     </span><span class="mi">73</span> <span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">74</span> <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">iterable_with_config</span><span class="p">)</span>

<span class="nn">File C:\Anaconda\Lib\site-packages\joblib\parallel.py:1918,</span> in <span class="ni">Parallel.__call__</span><span class="nt">(self, iterable)</span>
<span class="g g-Whitespace">   </span><span class="mi">1916</span>     <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sequential_output</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1917</span>     <span class="nb">next</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1918</span>     <span class="k">return</span> <span class="n">output</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_generator</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1920</span> <span class="c1"># Let&#39;s create an ID that uniquely identifies the current call. If the</span>
<span class="g g-Whitespace">   </span><span class="mi">1921</span> <span class="c1"># call is interrupted early and that the same instance is immediately</span>
<span class="g g-Whitespace">   </span><span class="mi">1922</span> <span class="c1"># re-used, this id will be used to prevent workers that were</span>
<span class="g g-Whitespace">   </span><span class="mi">1923</span> <span class="c1"># concurrently finalizing a task from the previous call to run the</span>
<span class="g g-Whitespace">   </span><span class="mi">1924</span> <span class="c1"># callback.</span>
<span class="g g-Whitespace">   </span><span class="mi">1925</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>

<span class="nn">File C:\Anaconda\Lib\site-packages\joblib\parallel.py:1847,</span> in <span class="ni">Parallel._get_sequential_output</span><span class="nt">(self, iterable)</span>
<span class="g g-Whitespace">   </span><span class="mi">1845</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_dispatched_batches</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="g g-Whitespace">   </span><span class="mi">1846</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_dispatched_tasks</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="ne">-&gt; </span><span class="mi">1847</span> <span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1848</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_completed_tasks</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="g g-Whitespace">   </span><span class="mi">1849</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_progress</span><span class="p">()</span>

<span class="nn">File C:\Anaconda\Lib\site-packages\sklearn\utils\parallel.py:136,</span> in <span class="ni">_FuncWrapper.__call__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">134</span>     <span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span> <span class="k">with</span> <span class="n">config_context</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">136</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">File C:\Anaconda\Lib\site-packages\sklearn\ensemble\_forest.py:192,</span> in <span class="ni">_parallel_build_trees</span><span class="nt">(tree, bootstrap, X, y, sample_weight, tree_idx, n_trees, verbose, class_weight, n_samples_bootstrap, missing_values_in_feature_mask)</span>
<span class="g g-Whitespace">    </span><span class="mi">189</span>     <span class="k">elif</span> <span class="n">class_weight</span> <span class="o">==</span> <span class="s2">&quot;balanced_subsample&quot;</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">190</span>         <span class="n">curr_sample_weight</span> <span class="o">*=</span> <span class="n">compute_sample_weight</span><span class="p">(</span><span class="s2">&quot;balanced&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">192</span>     <span class="n">tree</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">193</span>         <span class="n">X</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">194</span>         <span class="n">y</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">195</span>         <span class="n">sample_weight</span><span class="o">=</span><span class="n">curr_sample_weight</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">196</span>         <span class="n">check_input</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">197</span>         <span class="n">missing_values_in_feature_mask</span><span class="o">=</span><span class="n">missing_values_in_feature_mask</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">198</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">199</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">200</span>     <span class="n">tree</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">201</span>         <span class="n">X</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">202</span>         <span class="n">y</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">205</span>         <span class="n">missing_values_in_feature_mask</span><span class="o">=</span><span class="n">missing_values_in_feature_mask</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>     <span class="p">)</span>

<span class="nn">File C:\Anaconda\Lib\site-packages\sklearn\tree\_classes.py:472,</span> in <span class="ni">BaseDecisionTree._fit</span><span class="nt">(self, X, y, sample_weight, check_input, missing_values_in_feature_mask)</span>
<span class="g g-Whitespace">    </span><span class="mi">461</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">462</span>     <span class="n">builder</span> <span class="o">=</span> <span class="n">BestFirstTreeBuilder</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">463</span>         <span class="n">splitter</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">464</span>         <span class="n">min_samples_split</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">469</span>         <span class="bp">self</span><span class="o">.</span><span class="n">min_impurity_decrease</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">470</span>     <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">472</span> <span class="n">builder</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sample_weight</span><span class="p">,</span> <span class="n">missing_values_in_feature_mask</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">474</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_outputs_</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">is_classifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">475</span>     <span class="bp">self</span><span class="o">.</span><span class="n">n_classes_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_classes_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="random-forest-classifier-roc-auc-and-pca-feature-importance">
<h1>Random Forest Classifier: ROC-AUC and PCA Feature Importance<a class="headerlink" href="#random-forest-classifier-roc-auc-and-pca-feature-importance" title="Link to this heading">#</a></h1>
<p>Trained a Random Forest on PC1–PC5 to assess whether nonlinear modeling improves predictive signal over logistic regression.</p>
<section id="results">
<h2>Results<a class="headerlink" href="#results" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>ROC-AUC = 0.5798</strong> — slightly better than logistic (0.5602), still below actionable levels</p></li>
<li><p><strong>PC3 and PC2</strong> dominate importance, suggesting latent structure not captured linearly</p></li>
<li><p>PC1 contributes the least, despite being the largest variance component</p></li>
</ul>
</section>
<section id="id19">
<h2>Takeaway<a class="headerlink" href="#id19" title="Link to this heading">#</a></h2>
<p>Random Forest detects <strong>mild nonlinear relationships</strong> among PCA features, especially via PC3. However, despite higher AUC,
the edge remains <strong>statistically shallow</strong> and <strong>economically fragile</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span>

<span class="c1"># Assume we’re still in the same notebook with X_test, y_test, y_prob_rf, df backtest frame</span>
<span class="c1"># df_back already contains price/ATR aligned to y_prob_rf</span>

<span class="c1"># 1) Attach RF probabilities to df_back</span>
<span class="n">df_back</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">):]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob_rf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_prob_rf</span>

<span class="c1"># 2) Scan thresholds for trade counts</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trade counts at various thresholds:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.52</span><span class="p">,</span> <span class="mf">0.54</span><span class="p">,</span> <span class="mf">0.56</span><span class="p">,</span> <span class="mf">0.58</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;α = </span><span class="si">{</span><span class="n">alpha</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="p">(</span><span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob_rf&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">alpha</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> trades&quot;</span><span class="p">)</span>

<span class="c1"># 3) Choose a threshold (e.g., alpha_rf = 0.52)</span>
<span class="n">alpha_rf</span> <span class="o">=</span> <span class="mf">0.52</span>
<span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;signal_rf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob_rf&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">alpha_rf</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># 4) Compute R‑multiples (2‑bar horizon)</span>
<span class="n">R_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_back</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;signal_rf&#39;</span><span class="p">]:</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">exit</span>  <span class="o">=</span> <span class="n">df_back</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="n">h</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_back</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">risk</span>  <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">exit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">risk</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">R_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">exit</span> <span class="o">-</span> <span class="n">entry</span><span class="p">)</span> <span class="o">/</span> <span class="n">risk</span><span class="p">)</span>

<span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R_list</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Backtest Results (RF, α=</span><span class="si">{</span><span class="n">alpha_rf</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; • Trades:    </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; • Win rate:  </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">R</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; • Avg R:     </span><span class="si">{</span><span class="n">R</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; • Sharpe R:  </span><span class="si">{</span><span class="n">R</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="n">R</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 5) Plot R‑multiple histogram</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R‑Multiple Histogram (RF, α=</span><span class="si">{</span><span class="n">alpha_rf</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;R‑multiple&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Trade counts at various thresholds:
α = 0.50: 37733 trades
α = 0.52: 18021 trades
α = 0.54: 11165 trades
α = 0.56: 7442 trades
α = 0.58: 3884 trades

Backtest Results (RF, α=0.52):
 • Trades:    18021
 • Win rate:  63.63%
 • Avg R:     0.409
 • Sharpe R:  0.320
</pre></div>
</div>
<img alt="_images/a3caaab7cee8b3d60657b48306b8a2e201e2259ed87aafcf1a821cbc1ae8c609.png" src="_images/a3caaab7cee8b3d60657b48306b8a2e201e2259ed87aafcf1a821cbc1ae8c609.png" />
</div>
</div>
</section>
</section>
<section id="backtest-results-random-forest-signal-at-0-52">
<h1>Backtest Results: Random Forest Signal at α = 0.52<a class="headerlink" href="#backtest-results-random-forest-signal-at-0-52" title="Link to this heading">#</a></h1>
<p>A trade was entered when <code class="docutils literal notranslate"><span class="pre">P(up)</span> <span class="pre">&gt;</span> <span class="pre">0.52</span></code> from the Random Forest model. Position was held for 2 bars and R defined as (Exit − Entry)/ATR.</p>
<section id="id20">
<h2>Results<a class="headerlink" href="#id20" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Trades:</strong> 18,021</p></li>
<li><p><strong>Win rate:</strong> 63.6%</p></li>
<li><p><strong>Avg R:</strong> 0.409</p></li>
<li><p><strong>Sharpe R:</strong> 0.320</p></li>
</ul>
</section>
<section id="id21">
<h2>Interpretation<a class="headerlink" href="#id21" title="Link to this heading">#</a></h2>
<p>Despite encouraging stats, the histogram is <strong>heavily concentrated near 0R</strong>, with long tails distorting the scale. Most trades yield <strong>sub-1R results</strong>, and very few exceed ±3R. Visual skew is caused by rare outliers (e.g., +20R).</p>
</section>
<section id="id22">
<h2>Takeaway<a class="headerlink" href="#id22" title="Link to this heading">#</a></h2>
<p>While RF yields higher Sharpe and better calibration than logistic, the <strong>R-multiple distribution is shallow</strong>, and the <strong>economic edge remains fragile</strong> once transaction costs are considered. Histogram visualization overstates tail performance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># —— 1. Define your threshold alpha ——</span>
<span class="n">alpha_rf</span> <span class="o">=</span> <span class="mf">0.52</span>  

<span class="c1"># —— 2. Ensure df_back has Close, ATR_14, and Low columns ——</span>
<span class="c1"># If Low is missing, re-add from original_df (only test set portion)</span>
<span class="k">if</span> <span class="s1">&#39;Low&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_back</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">):]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># —— 3. Compute RF probabilities again &amp; define signal ——</span>
<span class="n">probs_rf</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">df_back</span> <span class="o">=</span> <span class="n">df_back</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>           <span class="c1"># align indices</span>
<span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob_rf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probs_rf</span>
<span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob_rf&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">alpha_rf</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># —— 4. Build R_rf list of R‑multiples (no stop‑loss) ——</span>
<span class="n">R_rf</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># holding period</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_back</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]:</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">exit_price</span> <span class="o">=</span> <span class="n">df_back</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_back</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">risk</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">exit_price</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">risk</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">R_rf</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">exit_price</span> <span class="o">-</span> <span class="n">entry</span><span class="p">)</span> <span class="o">/</span> <span class="n">risk</span><span class="p">)</span>
<span class="n">R_rf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R_rf</span><span class="p">)</span>

<span class="c1"># —— 5. Plot full R‑multiple histogram ——</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">R_rf</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Histogram of R‑Multiples (RF, α=</span><span class="si">{</span><span class="n">alpha_rf</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">R_rf</span><span class="p">)</span><span class="si">}</span><span class="s2"> trades)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;R‑multiple&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># —— 6. Now simulate 1 R stop‑loss for each of those trades ——</span>
<span class="n">R_sl</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_back</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]:</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">stop_loss</span> <span class="o">=</span> <span class="n">entry</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]</span>
        <span class="n">segment</span> <span class="o">=</span> <span class="n">df_back</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_back</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">]]</span>
        
        <span class="c1"># If any Low breaches the stop, record -1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">stop_loss</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">R_sl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exit_price</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">R_sl</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">exit_price</span> <span class="o">-</span> <span class="n">entry</span><span class="p">)</span> <span class="o">/</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">])</span>
<span class="n">R_sl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R_sl</span><span class="p">)</span>

<span class="c1"># —— 7. Plot the R_sl histogram ——</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">R_sl</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">70</span><span class="p">),</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R‑Multiple with 1 R Stop‑Loss (RF, α=</span><span class="si">{</span><span class="n">alpha_rf</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;R‑multiple&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># —— 8. Print summary stats ——</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No Stop‑Loss:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; • Trades: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">R_rf</span><span class="p">)</span><span class="si">}</span><span class="s2">  • Win rate: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">R_rf</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">  • Avg R: </span><span class="si">{</span><span class="n">R_rf</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">  • Sharpe: </span><span class="si">{</span><span class="n">R_rf</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">R_rf</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;With 1 R Stop‑Loss:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; • Trades: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">R_sl</span><span class="p">)</span><span class="si">}</span><span class="s2">  • Win rate: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">R_sl</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">  • Avg R: </span><span class="si">{</span><span class="n">R_sl</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">  • Sharpe: </span><span class="si">{</span><span class="n">R_sl</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">R_sl</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">67</span><span class="p">],</span> <span class="n">line</span> <span class="mi">11</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="c1"># —— 2. Ensure df_back has Close, ATR_14, and Low columns ——</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="c1"># If Low is missing, re-add from original_df (only test set portion)</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="k">if</span> <span class="s1">&#39;Low&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_back</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">11</span>     <span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">):]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span> <span class="c1"># —— 3. Compute RF probabilities again &amp; define signal ——</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span> <span class="n">probs_rf</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="ne">NameError</span>: name &#39;original_df&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># After merging PCA features, include all OHLC + ATR</span>
<span class="n">pc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_pca_enhanced_clean.csv&quot;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">])</span>
<span class="n">orig</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_with_new_decorrelated_indicators.csv&quot;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">])</span>
<span class="n">df</span>    <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pc_df</span><span class="p">,</span>
                 <span class="n">orig</span><span class="p">[[</span><span class="s1">&#39;Local time&#39;</span><span class="p">,</span><span class="s1">&#39;Open&#39;</span><span class="p">,</span><span class="s1">&#39;High&#39;</span><span class="p">,</span><span class="s1">&#39;Low&#39;</span><span class="p">,</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]],</span>
                 <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Local time&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">split</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">*</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">df_back</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split</span><span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># ---- Align df_back with X_test ----</span>
<span class="n">probs_rf</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">df_back</span> <span class="o">=</span> <span class="n">df_back</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">probs_rf</span><span class="p">)</span> <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># ---- Define threshold and signal ----</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.52</span>
<span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob_rf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probs_rf</span>
<span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob_rf&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">alpha</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">horizons</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="n">summary</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">horizons</span><span class="p">:</span>
    <span class="n">R_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_back</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]:</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
            <span class="n">stop</span>  <span class="o">=</span> <span class="n">entry</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]</span>
            <span class="c1"># restrict window to available rows</span>
            <span class="n">end</span>  <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_back</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">df_back</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="s1">&#39;Close&#39;</span><span class="p">]]</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">window</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">R_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exit_price</span> <span class="o">=</span> <span class="n">window</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">R_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">exit_price</span> <span class="o">-</span> <span class="n">entry</span><span class="p">)</span> <span class="o">/</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">])</span>
    
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R_list</span><span class="p">)</span>
    <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;horizon&#39;</span><span class="p">:</span> <span class="n">h</span><span class="p">,</span>
        <span class="s1">&#39;n_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">),</span>
        <span class="s1">&#39;avg_R&#39;</span><span class="p">:</span> <span class="n">R</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="s1">&#39;sharpe_R&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="n">R</span><span class="o">.</span><span class="n">std</span><span class="p">())</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="p">})</span>

<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">summary_df</span><span class="p">)</span>

<span class="c1"># ---- Plot Sharpe vs Horizon ----</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">summary_df</span><span class="p">[</span><span class="s1">&#39;horizon&#39;</span><span class="p">],</span> <span class="n">summary_df</span><span class="p">[</span><span class="s1">&#39;sharpe_R&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">horizons</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Holding Period (bars)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Sharpe (R)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sharpe vs Holding Period (α=</span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="logistic-regression-roc-curve-2bar-horizon">
<h1>Logistic Regression ROC Curve (2‑Bar Horizon)<a class="headerlink" href="#logistic-regression-roc-curve-2bar-horizon" title="Link to this heading">#</a></h1>
<section id="the-function">
<h2>The Function<a class="headerlink" href="#the-function" title="Link to this heading">#</a></h2>
<p>Here, I retrain my logistic regression model using a 2-bar return horizon instead of the original 3-bar setup. I calculate forward returns (<code class="docutils literal notranslate"><span class="pre">fut_ret_2</span></code>) and classify each example as an up or down move based on whether the return is positive. The model is trained on the first five principal components and evaluated using ROC‑AUC.</p>
</section>
<section id="why-i-did-this">
<h2>Why I Did This<a class="headerlink" href="#why-i-did-this" title="Link to this heading">#</a></h2>
<p>The original model failed to produce meaningful signals, possibly due to a weak relationship between features and future price movement over 3 bars. I reduced the prediction horizon to 2 bars to explore whether shorter-term dynamics carry more predictive signal.</p>
</section>
<section id="narrative">
<h2>Narrative<a class="headerlink" href="#narrative" title="Link to this heading">#</a></h2>
<p>The ROC curve visualizes the model’s ability to discriminate between up and down movements across thresholds. However, the curve still lies near the diagonal, and the ROC‑AUC score is close to 0.5, which indicates performance near random guessing.</p>
</section>
<section id="id23">
<h2>Takeaway<a class="headerlink" href="#id23" title="Link to this heading">#</a></h2>
<p>Reducing the lookahead horizon did not meaningfully improve predictive power. This further confirms that the first 5 principal components—at least in their current form—may not contain strong directional signal for short-term price changes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># 1) Summary stats</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total trades: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">R_rf</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Min R: </span><span class="si">{</span><span class="n">R_rf</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, Max R: </span><span class="si">{</span><span class="n">R_rf</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 2) Count &amp; % above thresholds</span>
<span class="n">thresholds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="n">summary</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">thresholds</span><span class="p">:</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">R_rf</span> <span class="o">&gt;=</span> <span class="n">t</span><span class="p">)</span>
    <span class="n">pct</span>   <span class="o">=</span> <span class="n">count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">R_rf</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;R ≥&#39;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span> <span class="s1">&#39;Count&#39;</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">% o</span><span class="s1">f trades&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pct</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># 3) Zoomed histogram</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">R_rf</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">60</span><span class="p">),</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;R‑multiple&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Zoomed Histogram of R‑Multiples (RF, α=0.52)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="random-forest-backtest-r-multiple-histogram-0-52">
<h1>📊 Random Forest Backtest – R-Multiple Histogram (α = 0.52)<a class="headerlink" href="#random-forest-backtest-r-multiple-histogram-0-52" title="Link to this heading">#</a></h1>
<section id="id24">
<h2>The Function<a class="headerlink" href="#id24" title="Link to this heading">#</a></h2>
<p>In this section, I visualize the return distribution (in R-multiples) from a backtest using a Random Forest classifier with a probability threshold of 0.52. Each signal is held for a fixed period, and returns are normalized by ATR to produce interpretable risk-adjusted metrics. I compute summary stats, tail performance, and plot the histogram.</p>
</section>
<section id="id25">
<h2>Why I Did This<a class="headerlink" href="#id25" title="Link to this heading">#</a></h2>
<p>While model metrics like ROC-AUC offer insight into classification accuracy, they do not directly translate to economic value. This histogram is designed to evaluate how well the model performs in <strong>position sizing and stop-loss context</strong>—the real-world implications of the predicted signals.</p>
</section>
<section id="id26">
<h2>Narrative<a class="headerlink" href="#id26" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Trade sample</strong>: 18,021 total trades, a substantial evaluation set.</p></li>
<li><p><strong>Tail performance</strong>: Around 23% of signals achieved <strong>1R or more</strong>, but this quickly drops:</p>
<ul>
<li><p>Only 6.72% exceed 2R,</p></li>
<li><p>Just 2.4% reach 3R,</p></li>
<li><p>Only 1.1% make it to 4R.</p></li>
</ul>
</li>
<li><p><strong>Histogram</strong>: The distribution is <strong>positively skewed</strong>, but still concentrated near 0. The left tail cuts off at -2R (from hard stop losses), while the right tail stretches to above 8R with rare outliers reaching as high as 30R. However, these long right tails are extremely rare.</p></li>
<li><p><strong>Peak region</strong>: The modal return is slightly above zero, with a large bulk of trades between -1R and +2R, reinforcing the idea that this model is not generating particularly explosive moves.</p></li>
</ul>
</section>
<section id="id27">
<h2>Takeaway<a class="headerlink" href="#id27" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Risk/reward distribution is weak</strong>: Despite the long right tail, the overwhelming majority of trades result in small or break-even returns. The model does not show strong edge at the α=0.52 threshold.</p></li>
<li><p><strong>Skewed but not reliable</strong>: While positive skew is generally encouraging, the histogram reveals a system that is dependent on rare outliers and has modest hit rates.</p></li>
</ul>
<p>This reinforces the need to explore <strong>different thresholds, dynamic holding periods, or ensemble stacking</strong> to improve trade-level performance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span>

<span class="c1"># 1) Initialize &amp; train XGBoost (same train/test split as RF)</span>
<span class="n">xgb</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span>
    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">max_depth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">subsample</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">colsample_bytree</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>
<span class="n">xgb</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># 2) Predict &amp; AUC</span>
<span class="n">y_prob_xgb</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">auc_xgb</span>    <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_prob_xgb</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ XGBoost ROC‑AUC: </span><span class="si">{</span><span class="n">auc_xgb</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ---- Add new candlestick patterns in‑memory ----</span>

<span class="c1"># 1) Doji: very small body relative to range</span>
<span class="n">body_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
<span class="n">range_size</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_doji&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">body_size</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">range_size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># 2) Hammer / Hanging Man: small body, long lower shadow, short upper shadow</span>
<span class="n">upper_shadow</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span><span class="s1">&#39;Open&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">lower_shadow</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span><span class="s1">&#39;Open&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_hammer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">body_size</span> <span class="o">&lt;=</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">range_size</span><span class="p">)</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">lower_shadow</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">*</span><span class="n">body_size</span><span class="p">)</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">upper_shadow</span> <span class="o">&lt;=</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">body_size</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># 3) Piercing Pattern (bullish 2-bar)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev_open&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev_close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev_high&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev_low&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_piercing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev_close&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev_open&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev_close&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev_low&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev_high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev_low&#39;</span><span class="p">]))</span>
<span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># 4) Dark Cloud Cover (bearish 2-bar)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_darkcloud&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev_close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev_open&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev_close&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev_high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev_high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev_low&#39;</span><span class="p">]))</span>
<span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># 5) Morning Star (3-bar)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev2_close&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev2_open&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev2_high&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev2_low&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">body2</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev2_close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev2_open&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_morningstar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev2_close&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev2_open&#39;</span><span class="p">])</span> <span class="o">&amp;</span>                                  <span class="c1"># bar1 bearish</span>
    <span class="p">(</span><span class="n">body2</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="o">*</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev2_high&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev2_low&#39;</span><span class="p">]))</span> <span class="o">&amp;</span>                        <span class="c1"># bar2 small body</span>
    <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">])</span> <span class="o">&amp;</span>                                              <span class="c1"># bar3 bullish</span>
    <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev2_low&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev2_high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev2_low&#39;</span><span class="p">]))</span>
<span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># 6) Evening Star (3-bar)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_eveningstar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev2_close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev2_open&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">body2</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="o">*</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev2_high&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev2_low&#39;</span><span class="p">]))</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
    <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev2_high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev2_high&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prev2_low&#39;</span><span class="p">]))</span>
<span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Drop helper columns</span>
<span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;prev_open&#39;</span><span class="p">,</span><span class="s1">&#39;prev_close&#39;</span><span class="p">,</span><span class="s1">&#39;prev_high&#39;</span><span class="p">,</span><span class="s1">&#39;prev_low&#39;</span><span class="p">,</span><span class="s1">&#39;prev2_open&#39;</span><span class="p">,</span><span class="s1">&#39;prev2_close&#39;</span><span class="p">,</span><span class="s1">&#39;prev2_high&#39;</span><span class="p">,</span><span class="s1">&#39;prev2_low&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># 7) Verify counts</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;New candlestick pattern counts:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span>
    <span class="s1">&#39;Doji&#39;</span><span class="p">:</span>             <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_doji&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
    <span class="s1">&#39;Hammer/Hanging&#39;</span><span class="p">:</span>   <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_hammer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
    <span class="s1">&#39;Piercing&#39;</span><span class="p">:</span>         <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_piercing&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
    <span class="s1">&#39;DarkCloud&#39;</span><span class="p">:</span>        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_darkcloud&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
    <span class="s1">&#39;MorningStar&#39;</span><span class="p">:</span>      <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_morningstar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
    <span class="s1">&#39;EveningStar&#39;</span><span class="p">:</span>      <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_eveningstar&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="p">}))</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="roc-auc-pattern-frequency-xgboost-with-candlestick-signals">
<h1>🔍 ROC-AUC &amp; Pattern Frequency – XGBoost with Candlestick Signals<a class="headerlink" href="#roc-auc-pattern-frequency-xgboost-with-candlestick-signals" title="Link to this heading">#</a></h1>
<section id="id28">
<h2>The Function<a class="headerlink" href="#id28" title="Link to this heading">#</a></h2>
<p>This section trains an XGBoost classifier on principal components and new candlestick features, then reports model quality via ROC-AUC and counts the number of detected pattern occurrences. The goal is to link visually interpretable price action with model-driven predictions.</p>
</section>
<section id="id29">
<h2>Why I Did This<a class="headerlink" href="#id29" title="Link to this heading">#</a></h2>
<p>ROC-AUC gives a probabilistic measure of the classifier’s ability to distinguish upward vs downward returns. In trading, we also want <strong>interpretable features</strong>. Candlestick patterns offer that—if they improve model performance or show high frequency, they’re likely adding useful signal.</p>
</section>
<section id="id30">
<h2>Narrative<a class="headerlink" href="#id30" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Model Quality</strong>: The XGBoost classifier achieved an ROC-AUC of <strong>0.5763</strong>. This is modest, but <strong>above random</strong> (0.5), suggesting mild edge in predicting 2-bar returns.</p></li>
<li><p><strong>Interpretability Layer</strong>: Six additional patterns were engineered:</p>
<ul>
<li><p><strong>Doji</strong>: 34k occurrences — most common pattern</p></li>
<li><p><strong>Hammer/Hanging Man</strong>: 12.7k</p></li>
<li><p><strong>Piercing / Dark Cloud</strong> (bull/bear reversals): ~29k each</p></li>
<li><p><strong>Morning / Evening Star</strong> (3-bar reversals): ~18k each</p></li>
</ul>
</li>
</ul>
<p>These are highly structured, intuitive price-action rules, and their frequency supports their viability as input features in a learning system.</p>
</section>
<section id="id31">
<h2>Takeaway<a class="headerlink" href="#id31" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>ROC-AUC ~0.5763</strong> confirms that the classifier has learned some discriminatory structure.</p></li>
<li><p><strong>Candlestick patterns</strong> occurred with high frequency, making them feasible for large-scale model use.</p></li>
<li><p>This combination—statistical edge with interpretable rules—is crucial for both explainability and robustness in trading models.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># 1) Reload your merged DataFrame if needed</span>
<span class="c1"># df = pd.read_csv(&quot;gold_pca_enhanced_clean.csv&quot;, parse_dates=[&quot;Local time&quot;])</span>
<span class="c1"># orig = pd.read_csv(&quot;gold_with_new_decorrelated_indicators.csv&quot;, parse_dates=[&quot;Local time&quot;])</span>
<span class="c1"># df = pd.merge(df, orig[[&#39;Local time&#39;,&#39;Open&#39;,&#39;High&#39;,&#39;Low&#39;,&#39;Close&#39;,&#39;ATR_14&#39;]], on=&quot;Local time&quot;)</span>

<span class="c1"># 2) Define 2-bar forward return target</span>
<span class="n">horizon</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;fut_ret&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">horizon</span><span class="p">)</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="n">horizon</span><span class="p">]</span>  <span class="c1"># drop last rows</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;fut_ret&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># 3) Build all 10 candlestick patterns</span>
<span class="n">body</span>      <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span>
<span class="n">body_abs</span>  <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
<span class="n">rng</span>       <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span>
<span class="n">prev1_o</span><span class="p">,</span> <span class="n">prev1_c</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">prev1_h</span><span class="p">,</span> <span class="n">prev1_l</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">prev2_o</span><span class="p">,</span> <span class="n">prev2_c</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">prev2_h</span><span class="p">,</span> <span class="n">prev2_l</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">body2_abs</span> <span class="o">=</span> <span class="p">(</span><span class="n">prev2_c</span> <span class="o">-</span> <span class="n">prev2_o</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>

<span class="c1"># Originals</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;bull_engulf&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">prev1_c</span> <span class="o">&lt;</span> <span class="n">prev1_o</span><span class="p">)</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">prev1_c</span><span class="p">)</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">prev1_o</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;bear_engulf&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">prev1_c</span> <span class="o">&gt;</span> <span class="n">prev1_o</span><span class="p">)</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">prev1_c</span><span class="p">)</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">prev1_o</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;three_bar_rev_bull&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">body</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">body</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
                            <span class="p">(</span><span class="n">body_abs</span> <span class="o">&gt;</span> <span class="n">body</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span> <span class="o">&amp;</span>
                            <span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">body</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span> <span class="o">&amp;</span>
                            <span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">body_abs</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;three_bar_rev_bear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">body</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">body</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
                            <span class="p">(</span><span class="n">body_abs</span> <span class="o">&gt;</span> <span class="n">body</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span> <span class="o">&amp;</span>
                            <span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">body</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">())</span> <span class="o">&amp;</span>
                            <span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">body_abs</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># New patterns</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_doji&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="p">(</span><span class="n">body_abs</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">rng</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">upper_sh</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span><span class="s1">&#39;Open&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">lower_sh</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span><span class="s1">&#39;Open&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_hammer&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="p">((</span><span class="n">body_abs</span> <span class="o">&lt;=</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">rng</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lower_sh</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">*</span><span class="n">body_abs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">upper_sh</span> <span class="o">&lt;=</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">body_abs</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_piercing&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">((</span><span class="n">prev1_c</span> <span class="o">&lt;</span> <span class="n">prev1_o</span><span class="p">)</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">prev1_c</span><span class="p">)</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">prev1_l</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">prev1_h</span><span class="o">-</span><span class="n">prev1_l</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_darkcloud&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">prev1_c</span> <span class="o">&gt;</span> <span class="n">prev1_o</span><span class="p">)</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">prev1_c</span><span class="p">)</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">prev1_h</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">prev1_h</span><span class="o">-</span><span class="n">prev1_l</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_morningstar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">prev2_c</span> <span class="o">&lt;</span> <span class="n">prev2_o</span><span class="p">)</span> <span class="o">&amp;</span>
                             <span class="p">(</span><span class="n">body2_abs</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="o">*</span><span class="p">(</span><span class="n">prev2_h</span><span class="o">-</span><span class="n">prev2_l</span><span class="p">))</span> <span class="o">&amp;</span>
                             <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                             <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">prev2_l</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">prev2_h</span><span class="o">-</span><span class="n">prev2_l</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_eveningstar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">prev2_c</span> <span class="o">&gt;</span> <span class="n">prev2_o</span><span class="p">)</span> <span class="o">&amp;</span>
                             <span class="p">(</span><span class="n">body2_abs</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="o">*</span><span class="p">(</span><span class="n">prev2_h</span><span class="o">-</span><span class="n">prev2_l</span><span class="p">))</span> <span class="o">&amp;</span>
                             <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">])</span> <span class="o">&amp;</span>
                             <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">prev2_h</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">prev2_h</span><span class="o">-</span><span class="n">prev2_l</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># 4) Prepare feature matrix &amp; target</span>
<span class="n">pcs</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;PC</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
<span class="n">orig_cand</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bull_engulf&#39;</span><span class="p">,</span><span class="s1">&#39;bear_engulf&#39;</span><span class="p">,</span><span class="s1">&#39;three_bar_rev_bull&#39;</span><span class="p">,</span><span class="s1">&#39;three_bar_rev_bear&#39;</span><span class="p">]</span>
<span class="n">new_cand</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pattern_doji&#39;</span><span class="p">,</span><span class="s1">&#39;pattern_hammer&#39;</span><span class="p">,</span><span class="s1">&#39;pattern_piercing&#39;</span><span class="p">,</span>
             <span class="s1">&#39;pattern_darkcloud&#39;</span><span class="p">,</span><span class="s1">&#39;pattern_morningstar&#39;</span><span class="p">,</span><span class="s1">&#39;pattern_eveningstar&#39;</span><span class="p">]</span>
<span class="n">features</span>  <span class="o">=</span> <span class="n">pcs</span> <span class="o">+</span> <span class="n">orig_cand</span> <span class="o">+</span> <span class="n">new_cand</span>

<span class="c1"># Drop any NaNs (from shifts)</span>
<span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">features</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">,</span><span class="s1">&#39;Close&#39;</span><span class="p">,</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">features</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>

<span class="c1"># 5) Chronological split</span>
<span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">*</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
<span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
<span class="n">df_back</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># 6) Train XGBoost</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                      <span class="n">subsample</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">colsample_bytree</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                      <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span><span class="p">,</span> <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">y_prob</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ XGB (+10 patterns) ROC‑AUC: </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 7) Top feature importances</span>
<span class="n">imps</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">features</span><span class="p">)</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">imps</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">imps</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Top 10 Feature Importances&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># 8) Backtest at α=0.52, 1R stop, 2‑bar hold</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.52</span>
<span class="n">df_back</span> <span class="o">=</span> <span class="n">df_back</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">y_prob</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">y_prob</span>
<span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">alpha</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">R</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">df_back</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">];</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]</span>
        <span class="n">win</span> <span class="o">=</span> <span class="n">df_back</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">df_back</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">),:]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">R</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">R</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">win</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">e</span><span class="p">)</span><span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">])</span>

<span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Backtest Results (α=</span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; • Trades:   </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; • Win rate: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">R</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; • Avg R:    </span><span class="si">{</span><span class="n">R</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; • Sharpe:   </span><span class="si">{</span><span class="n">R</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="n">R</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 9) Zoomed R histogram</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">60</span><span class="p">),</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;R‑Multiple Histogram (+10 patterns)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;R‑multiple&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="xgboost-with-10-candlestick-patterns-roc-auc-r-multiple-histogram">
<h1>📊 XGBoost with 10 Candlestick Patterns – ROC-AUC &amp; R-Multiple Histogram<a class="headerlink" href="#xgboost-with-10-candlestick-patterns-roc-auc-r-multiple-histogram" title="Link to this heading">#</a></h1>
<section id="id32">
<h2>The Function<a class="headerlink" href="#id32" title="Link to this heading">#</a></h2>
<p>In this section, I combine traditional technical indicators (PC1–PC5) with 10 engineered candlestick pattern signals to train an XGBoost classifier. The goal is to improve predictive performance over a 2-bar return horizon. I evaluate the model using ROC-AUC and a backtest strategy based on R-multiples.</p>
</section>
<section id="id33">
<h2>Why I Did This<a class="headerlink" href="#id33" title="Link to this heading">#</a></h2>
<p>Earlier models using only PCA components showed poor predictive power. My hypothesis was that certain classic price action patterns—like hammer, engulfing, or doji—might contain edge over short-term horizons when modeled in conjunction with the broader feature space. This test explores whether such handcrafted features improve model robustness.</p>
</section>
<section id="id34">
<h2>Narrative<a class="headerlink" href="#id34" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>The <strong>first chart</strong> ranks the top 10 features by importance. Surprisingly, only <strong><code class="docutils literal notranslate"><span class="pre">pattern_hammer</span></code></strong> appears significantly predictive, dominating the bar plot. The rest, including PCA components and other candlestick patterns, barely register (all below 0.05 importance).</p></li>
<li><p>The <strong>second chart</strong>, an R-multiple histogram, summarizes trade-level outcomes for a 2-bar holding strategy with 1R stop and a signal threshold of 0.52. It shows a near-Gaussian distribution, centered around zero. The left tail (around -1R) contains a large mass (~7,900 losing trades), suggesting frequent stopouts. Very few trades reach 2R or beyond.</p></li>
</ul>
</section>
<section id="id35">
<h2>Takeaway<a class="headerlink" href="#id35" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Feature utility is concentrated</strong>: Only <code class="docutils literal notranslate"><span class="pre">pattern_hammer</span></code> stands out as contributing meaningful signal to the model. Most features, including PCA axes and well-known candlestick patterns like <code class="docutils literal notranslate"><span class="pre">doji</span></code>, <code class="docutils literal notranslate"><span class="pre">morningstar</span></code>, and <code class="docutils literal notranslate"><span class="pre">darkcloud</span></code>, are nearly useless under this test.</p></li>
<li><p><strong>Trade performance is weak</strong>: The backtest produced over 24,000 trades, but the <strong>win rate is below 50%</strong>, and <strong>average R is just 0.076</strong>, with a <strong>Sharpe of 0.069</strong>. The histogram confirms that most signals result in either small gains or immediate losses.</p></li>
</ul>
<p>These results indicate that while the <code class="docutils literal notranslate"><span class="pre">hammer</span></code> pattern might carry isolated edge, the overall framework lacks strong signal-to-noise. Additional feature refinement or nonlinear interactions may be required to extract usable alpha.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="c1"># 1) Align df_back</span>
<span class="n">probs</span> <span class="o">=</span> <span class="n">y_prob</span>  <span class="c1"># your best model’s P(up)</span>
<span class="n">df_back</span> <span class="o">=</span> <span class="n">df_back</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">probs</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probs</span>

<span class="c1"># 2) Grid parameters</span>
<span class="n">alphas</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.61</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>  <span class="c1"># [0.50,0.52,…,0.60]</span>
<span class="n">stop_mult</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]</span>              <span class="c1"># ×ATR</span>

<span class="c1"># 3) Prepare results DataFrame</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([</span><span class="n">alphas</span><span class="p">,</span> <span class="n">stop_mult</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span><span class="s1">&#39;stopR&#39;</span><span class="p">])</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;n_trades&#39;</span><span class="p">,</span><span class="s1">&#39;avg_R&#39;</span><span class="p">,</span><span class="s1">&#39;sharpe_R&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># 4) Loop grid</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># 2-bar hold</span>
<span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="n">alphas</span><span class="p">:</span>
    <span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">alpha</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">stop_mult</span><span class="p">:</span>
        <span class="n">R_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_back</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]:</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
                <span class="n">stop</span>  <span class="o">=</span> <span class="n">entry</span> <span class="o">-</span> <span class="n">m</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]</span>
                <span class="n">end</span>   <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_back</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">window</span> <span class="o">=</span> <span class="n">df_back</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">,</span><span class="s1">&#39;Close&#39;</span><span class="p">]]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">window</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">R_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">)</span>  <span class="c1"># loss = m R</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">R_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">window</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">entry</span><span class="p">)</span> <span class="o">/</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">])</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span> <span class="s1">&#39;n_trades&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span> <span class="s1">&#39;avg_R&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">m</span><span class="p">),</span> <span class="s1">&#39;sharpe_R&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">R</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

<span class="c1"># 5) Pivot for heatmap (Sharpe)</span>
<span class="n">shp</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;sharpe_R&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">shp</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.2f&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;RdYlGn&quot;</span><span class="p">,</span> 
            <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span><span class="s1">&#39;Sharpe (R)&#39;</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Sharpe Heatmap: Threshold α vs Stop‑Loss (×ATR)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Stop‑Loss Multiple&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Probability Threshold α&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># 6) Inspect the best cell</span>
<span class="n">best</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;sharpe_R&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;🏆 Best Sharpe at α=</span><span class="si">{</span><span class="n">best</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, Stop‑loss=</span><span class="si">{</span><span class="n">best</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">×ATR → Sharpe=</span><span class="si">{</span><span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">best</span><span class="p">,</span><span class="s1">&#39;sharpe_R&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="transactioncost-simulation">
<h1>7. Transaction‑Cost Simulation<a class="headerlink" href="#transactioncost-simulation" title="Link to this heading">#</a></h1>
<p>So far we’ve reported <strong>gross</strong> R‑multiples and Sharpe.<br />
In reality, each trade incurs:</p>
<ul class="simple">
<li><p><strong>Commission</strong> (e.g. 0.02% per side, 0.04% round‑trip)</p></li>
<li><p><strong>Slippage</strong> (e.g. 0.01% per side, 0.02% round‑trip)</p></li>
</ul>
<p>Total round‑trip friction ≈ <strong>0.06%</strong> of price.<br />
We’ll convert that into R‑units via:<br />
[
\text{cost}_R = \frac{\text{friction%}}{\text{ATR} / \text{price}}.
]
Then recompute <strong>net R</strong> and <strong>net Sharpe</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># —— Transaction‑Cost Simulation —— </span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Assume df_back already has &#39;signal&#39; and we just ran our best model:</span>
<span class="c1">#   df_back[&#39;prob&#39;], df_back[&#39;signal&#39;], R (gross)</span>

<span class="c1"># 1) Define friction assumptions</span>
<span class="n">commission_rt</span> <span class="o">=</span> <span class="mf">0.0004</span>   <span class="c1"># 0.04% round‑trip</span>
<span class="n">slippage_rt</span>   <span class="o">=</span> <span class="mf">0.0002</span>   <span class="c1"># 0.02% round‑trip</span>
<span class="n">friction_rt</span>   <span class="o">=</span> <span class="n">commission_rt</span> <span class="o">+</span> <span class="n">slippage_rt</span>

<span class="c1"># 2) Compute net R</span>
<span class="n">R_net</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_back</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]:</span>
        <span class="n">entry</span>     <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">stop</span>      <span class="o">=</span> <span class="n">entry</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]</span>  <span class="c1"># use your optimal stop</span>
        <span class="n">end</span>       <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_back</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">window</span>    <span class="o">=</span> <span class="n">df_back</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">,</span><span class="s1">&#39;Close&#39;</span><span class="p">]]</span>
        
        <span class="c1"># gross R</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">window</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">grossR</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exit_price</span> <span class="o">=</span> <span class="n">window</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">grossR</span> <span class="o">=</span> <span class="p">(</span><span class="n">exit_price</span> <span class="o">-</span> <span class="n">entry</span><span class="p">)</span> <span class="o">/</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]</span>
        
        <span class="c1"># convert friction_pct into R units:</span>
        <span class="n">costR</span> <span class="o">=</span> <span class="n">friction_rt</span> <span class="o">/</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">entry</span><span class="p">)</span>
        <span class="n">R_net</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grossR</span> <span class="o">-</span> <span class="n">costR</span><span class="p">)</span>

<span class="n">R_net</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R_net</span><span class="p">)</span>

<span class="c1"># 3) Compare gross vs net</span>
<span class="n">gross_mean</span><span class="p">,</span> <span class="n">gross_sh</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">R</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="n">R</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">net_mean</span><span class="p">,</span> <span class="n">net_sh</span>     <span class="o">=</span> <span class="n">R_net</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">R_net</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="n">R_net</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gross   Sharpe: </span><span class="si">{</span><span class="n">gross_sh</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, Avg R: </span><span class="si">{</span><span class="n">gross_mean</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Net     Sharpe: </span><span class="si">{</span><span class="n">net_sh</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, Avg R: </span><span class="si">{</span><span class="n">net_mean</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 4) Plot net R histogram</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">R_net</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">60</span><span class="p">),</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Net SR‑Multiple Histogram (with Costs)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;R‑multiple (net)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="transaction-cost-simulation-net-r-multiples">
<h1>💸 Transaction Cost Simulation – Net R-Multiples<a class="headerlink" href="#transaction-cost-simulation-net-r-multiples" title="Link to this heading">#</a></h1>
<section id="id36">
<h2>The Function<a class="headerlink" href="#id36" title="Link to this heading">#</a></h2>
<p>This section simulates the impact of <strong>realistic frictional costs</strong>—slippage and commissions—on strategy performance. We compute net R-multiples by subtracting a dynamic cost (based on ATR size) from each gross trade and visualize the shift in distribution.</p>
</section>
<section id="id37">
<h2>Why I Did This<a class="headerlink" href="#id37" title="Link to this heading">#</a></h2>
<p>Most backtests ignore transaction costs. But in real execution—especially on short horizons—<strong>costs erode profitability</strong>. A strategy that looks good gross may fail net. This stress test helps me evaluate robustness under friction.</p>
</section>
<section id="id38">
<h2>Narrative<a class="headerlink" href="#id38" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Friction assumptions</strong>: 0.06% round-trip (0.04% commission + 0.02% slippage).</p></li>
<li><p><strong>Gross results</strong>:</p>
<ul>
<li><p>Avg R: <strong>+0.382</strong></p></li>
<li><p>Sharpe: <strong>0.278</strong></p></li>
</ul>
</li>
<li><p><strong>Net results (post-cost)</strong>:</p>
<ul>
<li><p>Avg R: <strong>–0.834</strong></p></li>
<li><p>Sharpe: <strong>–0.541</strong></p></li>
</ul>
</li>
<li><p>The histogram now shows a <strong>left-skewed distribution</strong>, centered well below zero, with a mode near –1. This confirms the strategy becomes <strong>unprofitable after cost</strong>.</p></li>
</ul>
</section>
<section id="id39">
<h2>Takeaway<a class="headerlink" href="#id39" title="Link to this heading">#</a></h2>
<p>The model may show statistical edge <strong>in-sample</strong>, but its <strong>trading edge is not robust</strong> to friction. With short holding periods and moderate ATRs, even modest slippage/commission turns the system negative.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># 1) Invert the signal: long → short</span>
<span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;signal_short&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span>  

<span class="c1"># 2) Compute gross R for shorts (same 1.5ATR stop, 2‑bar hold)</span>
<span class="n">R_short</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">stop_mult</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">df_back</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;signal_short&#39;</span><span class="p">]:</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="c1"># for a short, stop‑loss is entry + stop_mult*ATR</span>
        <span class="n">stop</span>  <span class="o">=</span> <span class="n">entry</span> <span class="o">+</span> <span class="n">stop_mult</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]</span>
        <span class="n">end</span>   <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_back</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">window</span> <span class="o">=</span> <span class="n">df_back</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">,</span><span class="s1">&#39;Close&#39;</span><span class="p">]]</span>
        
        <span class="c1"># if any High breaches the short‑stop, loss = -stop_mult</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">window</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">R_short</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">stop_mult</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># profit = (entry – exit) / ATR</span>
            <span class="n">exit_price</span> <span class="o">=</span> <span class="n">window</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">R_short</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">entry</span> <span class="o">-</span> <span class="n">exit_price</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">])</span>

<span class="n">R_short</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R_short</span><span class="p">)</span>

<span class="c1"># 3) Print gross metrics</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🔄 Short‐Side Gross Performance&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; • Trades:   </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">R_short</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; • Win rate: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">R_short</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; • Avg R:    </span><span class="si">{</span><span class="n">R_short</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; • Sharpe:   </span><span class="si">{</span><span class="n">R_short</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="n">R_short</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span>

<span class="c1"># 1) Reload or reuse your main DataFrame and model</span>
<span class="c1"># If needed, reload df and model outputs here.</span>
<span class="c1"># E.g.:</span>
<span class="c1"># df = pd.read_csv(&quot;gold_with_features_and_pca.csv&quot;, parse_dates=[&quot;Local time&quot;])</span>
<span class="c1"># model = XGBClassifier(...).fit(X_train, y_train)</span>
<span class="c1"># y_prob = model.predict_proba(X_test)[:,1]</span>

<span class="c1"># 2) Rebuild df_back same as before</span>
<span class="n">split</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">)</span>
<span class="n">df_back</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split</span><span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">probs</span> <span class="o">=</span> <span class="n">y_prob</span>  <span class="c1"># ensure this is from your best model</span>
<span class="n">df_back</span> <span class="o">=</span> <span class="n">df_back</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">probs</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">probs</span>

<span class="c1"># 3) Define long-only signal and invert for short</span>
<span class="n">alpha_long</span> <span class="o">=</span> <span class="mf">0.60</span>
<span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;signal_long&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">alpha_long</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;signal_short&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">alpha_long</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># 4) Profit‑target scan with progress</span>
<span class="n">targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">tgt</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Profit target scan&quot;</span><span class="p">):</span>
    <span class="n">R_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">total_trades</span> <span class="o">=</span> <span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;signal_short&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">processed</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">df_back</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;signal_short&#39;</span><span class="p">]:</span>
            <span class="n">processed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
            <span class="n">stop</span>  <span class="o">=</span> <span class="n">entry</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]</span>
            <span class="n">take</span>  <span class="o">=</span> <span class="n">entry</span> <span class="o">-</span> <span class="n">tgt</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]</span>
            <span class="n">end</span>   <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_back</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">df_back</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">,</span><span class="s1">&#39;Low&#39;</span><span class="p">,</span><span class="s1">&#39;Close&#39;</span><span class="p">]]</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">window</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">R_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">window</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">take</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">R_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tgt</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ex</span> <span class="o">=</span> <span class="n">window</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">window</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
                <span class="n">R_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">entry</span> <span class="o">-</span> <span class="n">ex</span><span class="p">)</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">])</span>
            
            <span class="k">if</span> <span class="n">processed</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">processed</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_trades</span><span class="si">}</span><span class="s2"> short trades processed (target=</span><span class="si">{</span><span class="n">tgt</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">R)&quot;</span><span class="p">)</span>
    
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;target_R&#39;</span><span class="p">:</span> <span class="n">tgt</span><span class="p">,</span>
            <span class="s1">&#39;n_trades&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">),</span>
            <span class="s1">&#39;win_rate&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">R</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;avg_R&#39;</span><span class="p">:</span>     <span class="n">R</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s1">&#39;sharpe_R&#39;</span><span class="p">:</span>  <span class="n">R</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">R</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="p">})</span>

<span class="c1"># 5) Display results</span>
<span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;target_R&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Profit Target Scan Results:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res_df</span><span class="p">)</span>

<span class="c1"># 6) Plot Sharpe vs profit target</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">res_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;sharpe_R&#39;</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">/</span><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;theoretical opt ~1.13R&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Profit Target (R multiples)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Sharpe (R)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Short‑Side Sharpe vs Profit Target (1R stop)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="short-side-strategy-analysis-profit-target-optimization">
<h1>Short-Side Strategy Analysis: Profit Target Optimization<a class="headerlink" href="#short-side-strategy-analysis-profit-target-optimization" title="Link to this heading">#</a></h1>
<p>This analysis tests the effectiveness of short-side signals by scanning across a range of profit targets, with a fixed 1R stop and a 10-bar holding window.</p>
<section id="method">
<h2>Method<a class="headerlink" href="#method" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong>Signal Entry</strong>: <code class="docutils literal notranslate"><span class="pre">prob</span> <span class="pre">≤</span> <span class="pre">0.60</span></code></p></li>
<li><p><strong>Stop Loss</strong>: +1R (based on ATR)</p></li>
<li><p><strong>Take Profit</strong>: Scanned from 0.5R to 2.0R</p></li>
<li><p><strong>Holding Window</strong>: Max 10 bars</p></li>
</ul>
<p>For each trade, I computed R-multiples and calculated Sharpe ratios at each target level.</p>
</section>
<section id="observations">
<h2>Observations<a class="headerlink" href="#observations" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Sharpe ratio <strong>improves monotonically</strong> with profit target.</p></li>
<li><p>The <strong>highest Sharpe</strong> occurs at the <strong>maximum target tested (2.0R)</strong>.</p></li>
<li><p>The earlier “theoretical optimum” (≈1.13R) assumes symmetric and i.i.d. trades, which doesn’t hold here.</p></li>
<li><p>This suggests the model captures <strong>sustained short opportunities</strong>, which benefit from wider targets.</p></li>
</ul>
</section>
<section id="id40">
<h2>Takeaway<a class="headerlink" href="#id40" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>The <strong>short signal improves with more aggressive exits</strong>.</p></li>
<li><p>There’s <strong>no clear peak</strong> in the Sharpe curve within this range—performance might improve further above 2R.</p></li>
<li><p>This motivates:</p>
<ul>
<li><p>Extending the scan range (e.g. 2.5R, 3.0R)</p></li>
<li><p>Testing <strong>adaptive profit targets</strong></p></li>
<li><p>Possibly building a <strong>separate short-side model</strong></p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Copy of the test set and probability</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_prob</span>
<span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Define ATR-based stop size or fixed (e.g., 0.0010)</span>
<span class="n">risk</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>  <span class="c1"># 1x ATR</span>
<span class="n">reward</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">risk</span>                  <span class="c1"># 2R target</span>

<span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span> <span class="o">-</span> <span class="mi">10</span><span class="p">):</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">entry_price</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">stop_price</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">-</span> <span class="n">risk</span>
        <span class="n">target_price</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">+</span> <span class="n">reward</span>

        <span class="c1"># Look ahead max 10 bars</span>
        <span class="n">future_prices</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">11</span><span class="p">]</span>
        <span class="n">hit_tp</span> <span class="o">=</span> <span class="p">(</span><span class="n">future_prices</span> <span class="o">&gt;=</span> <span class="n">target_price</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="n">hit_sl</span> <span class="o">=</span> <span class="p">(</span><span class="n">future_prices</span> <span class="o">&lt;=</span> <span class="n">stop_price</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>

        <span class="c1"># Determine which comes first</span>
        <span class="n">tp_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">future_prices</span> <span class="o">&gt;=</span> <span class="n">target_price</span><span class="p">)</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span> <span class="k">if</span> <span class="n">hit_tp</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">sl_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">future_prices</span> <span class="o">&lt;=</span> <span class="n">stop_price</span><span class="p">)</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span> <span class="k">if</span> <span class="n">hit_sl</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">hit_tp</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">hit_sl</span> <span class="ow">or</span> <span class="n">tp_index</span> <span class="o">&lt;</span> <span class="n">sl_index</span><span class="p">):</span>
            <span class="n">pnl</span> <span class="o">=</span> <span class="n">reward</span>
            <span class="n">outcome</span> <span class="o">=</span> <span class="s1">&#39;TP&#39;</span>
        <span class="k">elif</span> <span class="n">hit_sl</span><span class="p">:</span>
            <span class="n">pnl</span> <span class="o">=</span> <span class="o">-</span><span class="n">risk</span>
            <span class="n">outcome</span> <span class="o">=</span> <span class="s1">&#39;SL&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Exit at final candle if neither hit</span>
            <span class="n">pnl</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">10</span><span class="p">]</span> <span class="o">-</span> <span class="n">entry_price</span>
            <span class="n">outcome</span> <span class="o">=</span> <span class="s1">&#39;TIME&#39;</span>

        <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;entry_time&#39;</span><span class="p">:</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;Local time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="n">entry_price</span><span class="p">,</span>
            <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="n">pnl</span><span class="p">,</span>
            <span class="s1">&#39;outcome&#39;</span><span class="p">:</span> <span class="n">outcome</span>
        <span class="p">})</span>

<span class="c1"># Convert to DataFrame</span>
<span class="n">bt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
<span class="n">bt</span><span class="p">[</span><span class="s1">&#39;cum_pnl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bt</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
<span class="n">bt</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bt</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">risk</span>

<span class="c1"># Metrics</span>
<span class="n">win_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">bt</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">sharpe</span> <span class="o">=</span> <span class="n">bt</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">bt</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
<span class="n">avg_return</span> <span class="o">=</span> <span class="n">bt</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">n_trades</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bt</span><span class="p">)</span>

<span class="c1"># Print summary</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Trades: </span><span class="si">{</span><span class="n">n_trades</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Win rate: </span><span class="si">{</span><span class="n">win_rate</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Avg Return per Trade: </span><span class="si">{</span><span class="n">avg_return</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Sharpe Ratio: </span><span class="si">{</span><span class="n">sharpe</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Final PnL: </span><span class="si">{</span><span class="n">bt</span><span class="p">[</span><span class="s1">&#39;cum_pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check if df_test is defined</span>
<span class="k">if</span> <span class="s1">&#39;df_test&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ df_test is loaded.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape:&quot;</span><span class="p">,</span> <span class="n">df_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Columns:&quot;</span><span class="p">,</span> <span class="n">df_test</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preview:&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">df_test</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ df_test is NOT loaded. You need to define or reload it.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">spearmanr</span><span class="p">,</span> <span class="n">pearsonr</span>

<span class="c1"># Calculate Spearman (rank) and Pearson (linear) correlations</span>
<span class="n">spearman_corr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">spearmanr</span><span class="p">(</span><span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">],</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;future_ret&#39;</span><span class="p">])</span>
<span class="n">pearson_corr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pearsonr</span><span class="p">(</span><span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">],</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;future_ret&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spearman correlation (prob vs. future_ret): </span><span class="si">{</span><span class="n">spearman_corr</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pearson correlation  (prob vs. future_ret): </span><span class="si">{</span><span class="n">pearson_corr</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Optional: Visualize</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;prob&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;future_ret&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_test</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Model Probability vs Future Return&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Model Probability&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Future Return&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span>

<span class="c1"># Convert future returns into a binary classification target</span>
<span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;binary_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;future_ret&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Fit logistic regression on model probabilities</span>
<span class="n">logreg</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">)</span>
<span class="n">logreg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_test</span><span class="p">[[</span><span class="s1">&#39;prob&#39;</span><span class="p">]],</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;binary_target&#39;</span><span class="p">])</span>

<span class="c1"># Predict probability of positive return</span>
<span class="n">predicted_probs</span> <span class="o">=</span> <span class="n">logreg</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">df_test</span><span class="p">[[</span><span class="s1">&#39;prob&#39;</span><span class="p">]])[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># Compute ROC AUC</span>
<span class="n">roc_auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;binary_target&#39;</span><span class="p">],</span> <span class="n">predicted_probs</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ROC AUC (using prob to classify future_ret &gt; 0): </span><span class="si">{</span><span class="n">roc_auc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Define helper to check if backtest exists</span>
<span class="k">def</span> <span class="nf">backtest_exists</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;bt&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bt</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;pnl&#39;</span> <span class="ow">in</span> <span class="n">bt</span><span class="o">.</span><span class="n">columns</span>

<span class="c1"># If backtest doesn&#39;t exist, run it</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">backtest_exists</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚙️ Running new backtest...&quot;</span><span class="p">)</span>

    <span class="c1"># Define or reuse model and features</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">feature_columns</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">feature_names_in_</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c1"># Fallback if model was trained using array</span>
        <span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;RSI_14&#39;</span><span class="p">,</span> <span class="s1">&#39;MACD&#39;</span><span class="p">,</span> <span class="s1">&#39;MACD_signal&#39;</span><span class="p">,</span> <span class="s1">&#39;ATR_14&#39;</span><span class="p">,</span> <span class="s1">&#39;EMA_9&#39;</span><span class="p">,</span> <span class="s1">&#39;EMA_21&#39;</span><span class="p">,</span>
            <span class="s1">&#39;log_volume&#39;</span><span class="p">,</span> <span class="s1">&#39;BB_width&#39;</span><span class="p">,</span> <span class="s1">&#39;CCI_14&#39;</span><span class="p">,</span> <span class="s1">&#39;vortex_diff&#39;</span><span class="p">,</span> <span class="s1">&#39;KST_roc&#39;</span>
        <span class="p">]</span>

    <span class="c1"># Prepare test data</span>
    <span class="n">df_test</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Generate probabilities if not already available</span>
    <span class="k">if</span> <span class="s1">&#39;prob&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_test</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">X_test</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="n">feature_columns</span><span class="p">]</span>
        <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Generate signal</span>
    <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Risk-reward parameters</span>
    <span class="n">risk</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="n">reward</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">risk</span>

    <span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span> <span class="o">-</span> <span class="mi">10</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">entry_price</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
            <span class="n">stop_price</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">-</span> <span class="n">risk</span>
            <span class="n">target_price</span> <span class="o">=</span> <span class="n">entry_price</span> <span class="o">+</span> <span class="n">reward</span>

            <span class="c1"># Look ahead max 10 bars</span>
            <span class="n">future_prices</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">11</span><span class="p">]</span>
            <span class="n">hit_tp</span> <span class="o">=</span> <span class="p">(</span><span class="n">future_prices</span> <span class="o">&gt;=</span> <span class="n">target_price</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
            <span class="n">hit_sl</span> <span class="o">=</span> <span class="p">(</span><span class="n">future_prices</span> <span class="o">&lt;=</span> <span class="n">stop_price</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>

            <span class="n">tp_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">future_prices</span> <span class="o">&gt;=</span> <span class="n">target_price</span><span class="p">)</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span> <span class="k">if</span> <span class="n">hit_tp</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">sl_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">future_prices</span> <span class="o">&lt;=</span> <span class="n">stop_price</span><span class="p">)</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span> <span class="k">if</span> <span class="n">hit_sl</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">hit_tp</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">hit_sl</span> <span class="ow">or</span> <span class="n">tp_index</span> <span class="o">&lt;</span> <span class="n">sl_index</span><span class="p">):</span>
                <span class="n">pnl</span> <span class="o">=</span> <span class="n">reward</span>
                <span class="n">outcome</span> <span class="o">=</span> <span class="s1">&#39;TP&#39;</span>
            <span class="k">elif</span> <span class="n">hit_sl</span><span class="p">:</span>
                <span class="n">pnl</span> <span class="o">=</span> <span class="o">-</span><span class="n">risk</span>
                <span class="n">outcome</span> <span class="o">=</span> <span class="s1">&#39;SL&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pnl</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">10</span><span class="p">]</span> <span class="o">-</span> <span class="n">entry_price</span>
                <span class="n">outcome</span> <span class="o">=</span> <span class="s1">&#39;TIME&#39;</span>

            <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;entry_time&#39;</span><span class="p">:</span> <span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;Local time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="s1">&#39;entry_price&#39;</span><span class="p">:</span> <span class="n">entry_price</span><span class="p">,</span>
                <span class="s1">&#39;pnl&#39;</span><span class="p">:</span> <span class="n">pnl</span><span class="p">,</span>
                <span class="s1">&#39;outcome&#39;</span><span class="p">:</span> <span class="n">outcome</span>
            <span class="p">})</span>

    <span class="c1"># Store results</span>
    <span class="n">bt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
    <span class="n">bt</span><span class="p">[</span><span class="s1">&#39;cum_pnl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bt</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">bt</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bt</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">risk</span>

    <span class="c1"># Metrics</span>
    <span class="n">win_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">bt</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">sharpe</span> <span class="o">=</span> <span class="n">bt</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">bt</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">avg_return</span> <span class="o">=</span> <span class="n">bt</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">n_trades</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bt</span><span class="p">)</span>

    <span class="c1"># Print summary</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Trades: </span><span class="si">{</span><span class="n">n_trades</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Win rate: </span><span class="si">{</span><span class="n">win_rate</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Avg Return per Trade: </span><span class="si">{</span><span class="n">avg_return</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Sharpe Ratio: </span><span class="si">{</span><span class="n">sharpe</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Final PnL: </span><span class="si">{</span><span class="n">bt</span><span class="p">[</span><span class="s1">&#39;cum_pnl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ Backtest already exists. Skipping re-run.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># ── ASSUMPTIONS ──</span>
<span class="c1"># df_test must contain:</span>
<span class="c1">#   - &#39;prob&#39;       : your model&#39;s predicted probability for an up-bar</span>
<span class="c1">#   - &#39;future_ret&#39; : the actual 2-bar forward return you used to train/test</span>
<span class="c1">#</span>
<span class="c1"># If you don’t already have future_ret in df_back, compute it:</span>
<span class="c1"># h = 2</span>
<span class="c1"># df_back[&#39;future_ret&#39;] = df_back[&#39;Close&#39;].shift(-h) / df_back[&#39;Close&#39;] - 1</span>
<span class="c1"># df_back = df_back.iloc[:-h].copy().reset_index(drop=True)</span>

<span class="c1"># Use the same test split</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">df_back</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># 1) Correlation between prob and future return</span>
<span class="n">corr</span> <span class="o">=</span> <span class="n">df_test</span><span class="p">[[</span><span class="s1">&#39;prob&#39;</span><span class="p">,</span><span class="s1">&#39;future_ret&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">,</span><span class="s1">&#39;future_ret&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Correlation (prob vs forward ret): </span><span class="si">{</span><span class="n">corr</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 2) Decile analysis: average return per prob–decile</span>
<span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;decile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">decile_means</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;decile&#39;</span><span class="p">)[</span><span class="s1">&#39;future_ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Average forward return by probability decile (0=lowest prob, 9=highest):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">decile_means</span><span class="p">)</span>

<span class="c1"># 3) Optional: a quick plot</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">decile_means</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Probability Decile&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Mean 2-bar Return&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Decile Test: Is Higher Prob → Higher Future Return?&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. Correlation</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_back</span><span class="p">[[</span><span class="s1">&#39;prob&#39;</span><span class="p">,</span><span class="s1">&#39;future_ret&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># 2. Decile means</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_back</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
    <span class="n">decile</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">],</span><span class="mi">10</span><span class="p">,</span><span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;decile&#39;</span><span class="p">)[</span><span class="s1">&#39;future_ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

<span class="c1"># 3. A simple ROC AUC</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span>
<span class="nb">print</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;future_ret&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">df_test</span> <span class="o">=</span> <span class="n">df_back</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;decile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">df_test</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">win_rates</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;decile&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="s1">&#39;future_ret&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Win rate by prob decile (0=lowest, 9=highest):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">win_rates</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">win_rates</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Probability Decile&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Win Rate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Decile Test: Higher Prob → Higher Win Rate&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># --- CONFIG ---</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">10</span>                  <span class="c1"># max bars to hold</span>
<span class="n">risk_mult</span> <span class="o">=</span> <span class="mf">1.0</span>         <span class="c1"># 1R</span>
<span class="n">reward_mult</span> <span class="o">=</span> <span class="mf">2.0</span>       <span class="c1"># 2R</span>
<span class="n">alpha_long</span> <span class="o">=</span> <span class="mf">0.52</span>       <span class="c1"># long threshold</span>
<span class="n">alpha_short</span> <span class="o">=</span> <span class="mf">0.48</span>      <span class="c1"># short threshold</span>
<span class="n">bars_per_day</span> <span class="o">=</span> <span class="mi">78</span>       <span class="c1"># approx. 6.5h * 12 bars/hour</span>

<span class="c1"># --- SIGNALS ---</span>
<span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;signal_long&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">alpha_long</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;signal_short&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">alpha_short</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># --- BACKTEST FUNCTIONS ---</span>
<span class="k">def</span> <span class="nf">backtest_side</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;long&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Non-overlapping R-multiple backtest for one side.&quot;&quot;&quot;</span>
    <span class="n">R_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="n">h</span><span class="p">:</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;signal_long&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">side</span><span class="o">==</span><span class="s1">&#39;long&#39;</span> <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;signal_short&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sig</span><span class="p">:</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
            <span class="n">atr</span>   <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]</span>
            <span class="n">risk</span>  <span class="o">=</span> <span class="n">risk_mult</span> <span class="o">*</span> <span class="n">atr</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">side</span><span class="o">==</span><span class="s1">&#39;long&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">entry</span> <span class="o">+</span> <span class="n">reward_mult</span> <span class="o">*</span> <span class="n">atr</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">side</span><span class="o">==</span><span class="s1">&#39;long&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">stop</span>   <span class="o">=</span> <span class="n">entry</span> <span class="o">-</span> <span class="n">risk</span>

            <span class="n">window</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="p">:</span> <span class="n">i</span><span class="o">+</span><span class="n">h</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">highs</span> <span class="o">=</span> <span class="n">window</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">]</span>
            <span class="n">lows</span>  <span class="o">=</span> <span class="n">window</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">side</span><span class="o">==</span><span class="s1">&#39;long&#39;</span><span class="p">:</span>
                <span class="n">hit_tp</span> <span class="o">=</span> <span class="p">(</span><span class="n">highs</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
                <span class="n">hit_sl</span> <span class="o">=</span> <span class="p">(</span><span class="n">lows</span>  <span class="o">&lt;=</span> <span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hit_tp</span> <span class="o">=</span> <span class="p">(</span><span class="n">lows</span>  <span class="o">&lt;=</span> <span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
                <span class="n">hit_sl</span> <span class="o">=</span> <span class="p">(</span><span class="n">highs</span> <span class="o">&gt;=</span> <span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>

            <span class="c1"># find which hit first</span>
            <span class="k">if</span> <span class="n">hit_tp</span><span class="p">:</span>
                <span class="n">idx_tp</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">index</span><span class="p">[</span> <span class="n">highs</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>  <span class="k">if</span> <span class="n">side</span><span class="o">==</span><span class="s1">&#39;long&#39;</span> <span class="k">else</span> <span class="n">lows</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">idx_tp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">hit_sl</span><span class="p">:</span>
                <span class="n">idx_sl</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">index</span><span class="p">[</span> <span class="n">lows</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>      <span class="k">if</span> <span class="n">side</span><span class="o">==</span><span class="s1">&#39;long&#39;</span> <span class="k">else</span> <span class="n">highs</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>   <span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">idx_sl</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">hit_tp</span> <span class="ow">and</span> <span class="p">(</span><span class="n">idx_sl</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">idx_tp</span> <span class="o">&lt;</span> <span class="n">idx_sl</span><span class="p">):</span>
                <span class="n">R_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reward_mult</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">hit_sl</span><span class="p">:</span>
                <span class="n">R_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">risk_mult</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># exit at last bar close</span>
                <span class="n">exit_price</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
                <span class="n">pnl</span> <span class="o">=</span> <span class="p">(</span><span class="n">exit_price</span> <span class="o">-</span> <span class="n">entry</span><span class="p">)</span> <span class="o">/</span> <span class="n">atr</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">side</span><span class="o">==</span><span class="s1">&#39;long&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">R_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pnl</span><span class="p">)</span>

            <span class="n">i</span> <span class="o">+=</span> <span class="n">h</span>  <span class="c1"># skip ahead to avoid overlap</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R_list</span><span class="p">)</span>

<span class="c1"># --- RUN BACKTEST ---</span>
<span class="n">R_long</span>  <span class="o">=</span> <span class="n">backtest_side</span><span class="p">(</span><span class="n">df_back</span><span class="p">,</span> <span class="s1">&#39;long&#39;</span><span class="p">)</span>
<span class="n">R_short</span> <span class="o">=</span> <span class="n">backtest_side</span><span class="p">(</span><span class="n">df_back</span><span class="p">,</span> <span class="s1">&#39;short&#39;</span><span class="p">)</span>

<span class="c1"># --- METRICS &amp; EQUITY ---</span>
<span class="k">def</span> <span class="nf">metrics_and_curve</span><span class="p">(</span><span class="n">R</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute metrics and equity curve; scale Sharpe for 5-min bars.&quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
    <span class="n">win_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">R</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">avg_R</span>    <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">std_R</span>    <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># annualize Sharpe: sqrt(bars_per_day * trading_days)</span>
    <span class="n">sharpe</span>   <span class="o">=</span> <span class="n">avg_R</span> <span class="o">/</span> <span class="n">std_R</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">bars_per_day</span> <span class="o">*</span> <span class="mi">252</span><span class="p">)</span> <span class="k">if</span> <span class="n">std_R</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">eq_curve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">trades</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">win_rate</span><span class="o">=</span><span class="n">win_rate</span><span class="p">,</span> <span class="n">avg_R</span><span class="o">=</span><span class="n">avg_R</span><span class="p">,</span>
                <span class="n">sharpe</span><span class="o">=</span><span class="n">sharpe</span><span class="p">,</span> <span class="n">pnl</span><span class="o">=</span><span class="n">eq_curve</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">eq_curve</span>

<span class="n">metrics_long</span><span class="p">,</span> <span class="n">curve_long</span>   <span class="o">=</span> <span class="n">metrics_and_curve</span><span class="p">(</span><span class="n">R_long</span><span class="p">)</span>
<span class="n">metrics_short</span><span class="p">,</span> <span class="n">curve_short</span> <span class="o">=</span> <span class="n">metrics_and_curve</span><span class="p">(</span><span class="n">R_short</span><span class="p">)</span>

<span class="c1"># --- PLOT EQUITY CURVES ---</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">curve_long</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Long 2R Exit&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">curve_short</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Short 2R Exit&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Sanity-Check Equity Curves (Non-Overlapping 2R Trades)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Trade Number&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cumulative R&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># --- PRINT SUMMARY ---</span>
<span class="k">def</span> <span class="nf">print_metrics</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trades:       </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;trades&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Win Rate:     </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;win_rate&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Avg R/trade:  </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;avg_R&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sharpe:       </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;sharpe&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final PnL R:  </span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;pnl&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">print_metrics</span><span class="p">(</span><span class="s2">&quot;Long Side&quot;</span><span class="p">,</span>  <span class="n">metrics_long</span><span class="p">)</span>
<span class="n">print_metrics</span><span class="p">(</span><span class="s2">&quot;Short Side&quot;</span><span class="p">,</span> <span class="n">metrics_short</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">talib</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">talib</span> <span class="o">=</span> <span class="kc">None</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span>

<span class="c1"># 1) Load data</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;gold_with_indicators.csv&quot;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Local time&quot;</span><span class="p">])</span>

<span class="c1"># 2) Create 2-bar forward return target</span>
<span class="n">h</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;future_ret&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="p">)</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="n">h</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;future_ret&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># 3) Candlestick patterns</span>
<span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;doji&#39;</span><span class="p">,</span><span class="s1">&#39;hammer&#39;</span><span class="p">,</span><span class="s1">&#39;darkcloud&#39;</span><span class="p">,</span><span class="s1">&#39;piercing&#39;</span><span class="p">,</span><span class="s1">&#39;morningstar&#39;</span><span class="p">,</span><span class="s1">&#39;eveningstar&#39;</span><span class="p">]</span>
<span class="k">if</span> <span class="n">talib</span><span class="p">:</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_doji&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">CDLDOJI</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_hammer&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">CDLHAMMER</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_darkcloud&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">CDLDARKCLOUDCOVER</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">penetration</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_piercing&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">CDLPIERCING</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_morningstar&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">CDLMORNINGSTAR</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">penetration</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pattern_eveningstar&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">talib</span><span class="o">.</span><span class="n">CDLEVENINGSTAR</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Open&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;High&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">],</span> <span class="n">penetration</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;pattern_</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># 4) Regime tagging</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Local time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">23</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Asian&#39;</span><span class="p">,</span><span class="s1">&#39;London&#39;</span><span class="p">,</span><span class="s1">&#39;NewYork&#39;</span><span class="p">])</span>
<span class="n">event_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2022-01-12 19:30:00&#39;</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2023-02-14 19:30:00&#39;</span><span class="p">)]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_event&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">event_times</span><span class="p">:</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Local time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="n">t</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)),</span> <span class="s1">&#39;is_event&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">],</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;sess&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_event&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;is_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># 5) Feature list</span>
<span class="n">indicators</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;EMA_9&#39;</span><span class="p">,</span><span class="s1">&#39;EMA_21&#39;</span><span class="p">,</span><span class="s1">&#39;EMA_50&#39;</span><span class="p">,</span><span class="s1">&#39;EMA_200&#39;</span><span class="p">,</span><span class="s1">&#39;MACD&#39;</span><span class="p">,</span><span class="s1">&#39;MACD_hist&#39;</span><span class="p">,</span>
              <span class="s1">&#39;RSI_14&#39;</span><span class="p">,</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">,</span><span class="s1">&#39;STDDEV_20&#39;</span><span class="p">,</span><span class="s1">&#39;ADX_14&#39;</span><span class="p">]</span>
<span class="n">pattern_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;pattern_</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">]</span>
<span class="n">regime_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sess_Asian&#39;</span><span class="p">,</span><span class="s1">&#39;sess_London&#39;</span><span class="p">,</span><span class="s1">&#39;sess_NewYork&#39;</span><span class="p">,</span><span class="s1">&#39;is_event&#39;</span><span class="p">]</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">indicators</span> <span class="o">+</span> <span class="n">pattern_cols</span> <span class="o">+</span> <span class="n">regime_cols</span>

<span class="c1"># 6) Standardize + PCA</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">features</span><span class="p">])</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pcs</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_scaled</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PC</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcs</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>

<span class="c1"># 7) Train/test &amp; XGBoost</span>
<span class="n">split</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">)</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="sa">f</span><span class="s1">&#39;PC</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">split</span><span class="p">]</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">split</span><span class="p">]</span>
<span class="n">X_test</span>  <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="sa">f</span><span class="s1">&#39;PC</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split</span><span class="p">:]</span>
<span class="n">y_test</span>  <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split</span><span class="p">:]</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                      <span class="n">subsample</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">colsample_bytree</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
                      <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span><span class="p">,</span> <span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">y_prob</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_test</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_prob</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Final Regime‑Aware XGB ROC‑AUC: </span><span class="si">{</span><span class="n">auc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="regime-aware-model-with-ta-lib-patterns">
<h1>Regime-Aware Model with TA-Lib Patterns<a class="headerlink" href="#regime-aware-model-with-ta-lib-patterns" title="Link to this heading">#</a></h1>
<section id="id41">
<h2>The Function<a class="headerlink" href="#id41" title="Link to this heading">#</a></h2>
<p>I trained an XGBoost model using PCA features derived from technical indicators, TA-Lib candlestick patterns, and regime tags (session + event).</p>
<hr class="docutils" />
<p>Final Regime‑Aware XGB ROC‑AUC: 0.5184</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
<span class="n">This</span> <span class="n">suggests</span> <span class="n">weak</span> <span class="n">predictive</span> <span class="n">power</span> <span class="kn">from</span> <span class="nn">regimes</span> <span class="ow">or</span> <span class="n">patterns</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">setup</span><span class="o">.</span>

<span class="o">---</span>

<span class="c1">### Takeaway</span>

<span class="n">Regime</span><span class="o">-</span><span class="n">aware</span> <span class="n">structure</span> <span class="ow">is</span> <span class="ow">in</span> <span class="n">place</span><span class="p">,</span> <span class="n">but</span> <span class="n">effectiveness</span> <span class="ow">is</span> <span class="n">limited</span><span class="o">.</span> <span class="n">Future</span> <span class="n">steps</span><span class="p">:</span> <span class="k">try</span> <span class="n">raw</span> <span class="n">features</span><span class="p">,</span> <span class="n">richer</span> <span class="n">models</span><span class="p">,</span> <span class="ow">and</span> <span class="n">check</span> <span class="n">feature</span> <span class="n">impact</span><span class="o">.</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ---- 8) Regime‑Aware Backtest (Long‑Only) ----</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># 1) Build backtest DataFrame aligned with probabilities</span>
<span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">)</span>
<span class="n">df_back</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_prob</span>  <span class="c1"># from previous regime‑aware model</span>

<span class="c1"># 2) Create long signal: P(up) &gt; alpha_long</span>
<span class="n">alpha_long</span> <span class="o">=</span> <span class="mf">0.60</span>
<span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;signal_long&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_back</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">alpha_long</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># 3) Backtest R‑multiples for long trades</span>
<span class="n">R_long</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">stop_mult</span> <span class="o">=</span> <span class="mf">1.5</span>  <span class="c1"># 1.5×ATR stop</span>
<span class="n">horizon</span>   <span class="o">=</span> <span class="mi">2</span>    <span class="c1"># 2‑bar max hold</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_back</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;signal_long&#39;</span><span class="p">]:</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span>
        <span class="n">stop</span>  <span class="o">=</span> <span class="n">entry</span> <span class="o">-</span> <span class="n">stop_mult</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">]</span>
        <span class="n">end</span>   <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">horizon</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_back</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">window</span> <span class="o">=</span> <span class="n">df_back</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">,</span><span class="s1">&#39;Close&#39;</span><span class="p">]]</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">window</span><span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">R_long</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">stop_mult</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exit_price</span> <span class="o">=</span> <span class="n">window</span><span class="p">[</span><span class="s1">&#39;Close&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">R_long</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">exit_price</span> <span class="o">-</span> <span class="n">entry</span><span class="p">)</span> <span class="o">/</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ATR_14&#39;</span><span class="p">])</span>

<span class="n">R_long</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R_long</span><span class="p">)</span>

<span class="c1"># 4) Summarize gross performance</span>
<span class="n">win_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">R_long</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">avg_R</span>     <span class="o">=</span> <span class="n">R_long</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">sharpe</span>    <span class="o">=</span> <span class="n">avg_R</span> <span class="o">/</span> <span class="n">R_long</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🔄 Regime‑Aware Long Backtest (α=0.60)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; • Trades:      </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">R_long</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; • Win rate:    </span><span class="si">{</span><span class="n">win_rate</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; • Avg R:       </span><span class="si">{</span><span class="n">avg_R</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; • Gross Sharpe:</span><span class="si">{</span><span class="n">sharpe</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 5) Plot R‑multiple histogram</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">R_long</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Regime‑Aware Long R‑Multiple Distribution&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;R‑multiple&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="regime-aware-long-backtest-0-60">
<h1>Regime-Aware Long Backtest (α = 0.60)<a class="headerlink" href="#regime-aware-long-backtest-0-60" title="Link to this heading">#</a></h1>
<section id="id42">
<h2>The Function<a class="headerlink" href="#id42" title="Link to this heading">#</a></h2>
<p>I evaluated the performance of a <strong>long-only backtest</strong> using the regime-aware XGBoost model. The model outputs a probability of upward movement (<code class="docutils literal notranslate"><span class="pre">P(up)</span></code>), and I trigger long entries when this probability exceeds a threshold of <strong>0.60</strong>. Each trade is held for <strong>2 bars</strong> or stopped earlier using a <strong>1.5×ATR stop</strong>.</p>
</section>
<hr class="docutils" />
<section id="why-we-did-this-research-and-this-path">
<h2>Why We Did This Research and This Path<a class="headerlink" href="#why-we-did-this-research-and-this-path" title="Link to this heading">#</a></h2>
<p>This backtest was designed to test whether including <strong>regime-awareness</strong> (via session encoding and event tagging) along with <strong>technical indicators</strong> and <strong>candlestick patterns</strong> improves the signal quality. If regime dynamics matter, then long trades filtered through high-confidence model probabilities should perform better than baseline models.</p>
</section>
<hr class="docutils" />
<section id="id43">
<h2>Narrative<a class="headerlink" href="#id43" title="Link to this heading">#</a></h2>
<p>The regime-aware model was first trained on standardized PCA features. After generating test-set probabilities, I aligned them with the test-set Close prices and ATR values. The signal logic was simple: <strong>go long</strong> when the model thinks <code class="docutils literal notranslate"><span class="pre">P(up)</span> <span class="pre">&gt;</span> <span class="pre">0.60</span></code>.</p>
<p>Performance was weak:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>• Trades:      1278  
• Win rate:    52.03%  
• Avg R:       0.015  
• Gross Sharpe:0.014
</pre></div>
</div>
<p>Despite a win rate slightly above 50%, the <strong>average reward per trade (R)</strong> is extremely low, and the <strong>Sharpe ratio is near zero</strong>. Visually, the histogram shows a strong left tail (many losses) and very few high-reward trades.</p>
</section>
<hr class="docutils" />
<section id="id44">
<h2>Takeaway<a class="headerlink" href="#id44" title="Link to this heading">#</a></h2>
<p>The inclusion of regime features such as session encoding and event tagging <strong>did not significantly improve</strong> the long-side profitability. This suggests that:</p>
<ul class="simple">
<li><p>The current regime tags are either <strong>insufficiently informative</strong> or not interacting well with the underlying model structure.</p></li>
<li><p>Model confidence (<code class="docutils literal notranslate"><span class="pre">P(up)</span> <span class="pre">&gt;</span> <span class="pre">0.60</span></code>) <strong>does not correspond to strong reward asymmetry</strong>.</p></li>
<li><p>The <strong>risk control via ATR stop-loss</strong> may be capping potential upside.</p></li>
</ul>
<p>These findings indicate that either the <strong>long-side alpha is weak</strong>, or this particular model setup does not capture enough directional signal when filtered with regime-aware features.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Feature Engineering: Core Technical Indicators</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#indicators-included">Indicators Included</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mathematical-concepts-used">Mathematical Concepts Used</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-pipeline-indicator-enrichment-to-pca-compression">Feature Pipeline: Indicator Enrichment to PCA Compression</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#steps-performed">Steps Performed</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Mathematical Concepts Used</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#pca-scree-plot-explained-variance-analysis">PCA Scree Plot: Explained Variance Analysis</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpretation">Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Mathematical Concepts Used</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#visual-preview-of-technical-indicators">Visual Preview of Technical Indicators</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#indicators-plotted">Indicators Plotted</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpretation-and-issue-observed">Interpretation and Issue Observed</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-this-means">What This Means</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#pca-on-de-correlated-indicators">🔍 PCA on De-correlated Indicators</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#scree-plot-interpretation">Scree Plot Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mathematical-justification">Mathematical Justification</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#pca-loadings-feature-contributions-to-pc1-and-pc2">📊 PCA Loadings: Feature Contributions to PC1 and PC2</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#observations-from-the-plot">Observations from the Plot</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Interpretation</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#pca-projection-feature-space-in-pc1-vs-pc2">🎯 PCA Projection: Feature Space in PC1 vs PC2</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-this-plot-shows">What This Plot Shows</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-this-matters">Why This Matters</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#log-volume-transformation-decorrelated-indicator-engineering">🧮 Log-Volume Transformation &amp; Decorrelated Indicator Engineering</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">📌 Steps Performed</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#pca-on-cleaned-expanded-indicators">PCA on Cleaned + Expanded Indicators</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#processing-steps">Processing Steps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">Scree Plot Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Mathematical Concepts Used</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#pca-on-standardized-features-with-log-volume">🧮 PCA on Standardized Features with Log-Volume</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#process">🔧 Process</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">📊 Scree Plot Interpretation</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#final-pca-scree-plot-fully-expanded-cleaned-features">Final PCA Scree Plot – Fully Expanded &amp; Cleaned Features</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pca-insights">PCA Insights</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#takeaway">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#pca-projection-pc1-vs-pc2-scatter">PCA Projection: PC1 vs PC2 Scatter</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visual-interpretation">Visual Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#mathematical-implication">Mathematical Implication</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#logistic-regression-on-pca-components-rocauc-evaluation">Logistic Regression on PCA Components: ROC‑AUC Evaluation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-setup">Model Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results-and-interpretation">Results and Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#prediction-confidence-check-histogram-of-logistic-regression-probabilities">Prediction Confidence Check: Histogram of Logistic Regression Probabilities</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#purpose">Purpose</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implications">Implications</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#logistic-regression-on-pca-features-2-bar-roc-auc-evaluation">Logistic Regression on PCA Features: 2-Bar ROC-AUC Evaluation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id11">Model Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id12">Results and Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id13">Implications</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id14">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#predicted-probability-histogram-2-bar-horizon">Predicted Probability Histogram (2-Bar Horizon)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id15">Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implication">Implication</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id16">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#backtest-results-r-multiple-distributions-by-threshold">Backtest Results: R-Multiple Distributions by Threshold</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id17">Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id18">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#random-forest-classifier-roc-auc-and-pca-feature-importance">Random Forest Classifier: ROC-AUC and PCA Feature Importance</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id19">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#backtest-results-random-forest-signal-at-0-52">Backtest Results: Random Forest Signal at α = 0.52</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id20">Results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id21">Interpretation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id22">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#logistic-regression-roc-curve-2bar-horizon">Logistic Regression ROC Curve (2‑Bar Horizon)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-function">The Function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-i-did-this">Why I Did This</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#narrative">Narrative</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id23">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#random-forest-backtest-r-multiple-histogram-0-52">📊 Random Forest Backtest – R-Multiple Histogram (α = 0.52)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id24">The Function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id25">Why I Did This</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id26">Narrative</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id27">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#roc-auc-pattern-frequency-xgboost-with-candlestick-signals">🔍 ROC-AUC &amp; Pattern Frequency – XGBoost with Candlestick Signals</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id28">The Function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id29">Why I Did This</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id30">Narrative</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id31">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#xgboost-with-10-candlestick-patterns-roc-auc-r-multiple-histogram">📊 XGBoost with 10 Candlestick Patterns – ROC-AUC &amp; R-Multiple Histogram</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id32">The Function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id33">Why I Did This</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id34">Narrative</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id35">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#transactioncost-simulation">7. Transaction‑Cost Simulation</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#transaction-cost-simulation-net-r-multiples">💸 Transaction Cost Simulation – Net R-Multiples</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id36">The Function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id37">Why I Did This</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id38">Narrative</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id39">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#short-side-strategy-analysis-profit-target-optimization">Short-Side Strategy Analysis: Profit Target Optimization</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#method">Method</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#observations">Observations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id40">Takeaway</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#regime-aware-model-with-ta-lib-patterns">Regime-Aware Model with TA-Lib Patterns</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id41">The Function</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#regime-aware-long-backtest-0-60">Regime-Aware Long Backtest (α = 0.60)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id42">The Function</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-we-did-this-research-and-this-path">Why We Did This Research and This Path</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id43">Narrative</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id44">Takeaway</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>